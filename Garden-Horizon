--[[
  CLOUDYZ HUB v1.0 â€” GARDEN HORIZONS
  RightShift = toggle UI
]]

if not game:IsLoaded() then game.Loaded:Wait() end
task.wait(3)

local Players         = game:GetService("Players")
local RS              = game:GetService("ReplicatedStorage")
local Workspace       = game:GetService("Workspace")
local CoreGui         = game:GetService("CoreGui")
local TweenService    = game:GetService("TweenService")
local UIS             = game:GetService("UserInputService")
local HttpService     = game:GetService("HttpService")
local RunService      = game:GetService("RunService")
local TeleportService = game:GetService("TeleportService")

local plr = Players.LocalPlayer

local RemoteEvents      = RS:WaitForChild("RemoteEvents", 10)
local HarvestFruit      = RemoteEvents and RemoteEvents:WaitForChild("HarvestFruit", 10)
local UseGear           = RemoteEvents and RemoteEvents:WaitForChild("UseGear", 10)
local ClaimSelectedPlot = RemoteEvents and RemoteEvents:WaitForChild("ClaimSelectedPlot", 10)
local PlotAvailUpdate   = RemoteEvents and RemoteEvents:WaitForChild("PlotAvailabilityUpdate", 10)
local SetStreamFocus    = RemoteEvents and RemoteEvents:WaitForChild("SetStreamingFocus", 10)
local ClaimRewardEv     = RemoteEvents and RemoteEvents:WaitForChild("ClaimReward", 10)
local ClaimQuestEv      = RemoteEvents and RemoteEvents:WaitForChild("ClaimQuest", 10)
local UpdateQuests      = RemoteEvents and RemoteEvents:WaitForChild("UpdateQuests", 10)
local RemovePlant       = RemoteEvents and RemoteEvents:WaitForChild("RemovePlant", 10)
local ToggleFavoriteEv  = RemoteEvents and RemoteEvents:WaitForChild("ToggleFavorite", 10)
local PurchaseShopItem  = RemoteEvents and RemoteEvents:WaitForChild("PurchaseShopItem", 10)
local SellItems         = RemoteEvents and RemoteEvents:WaitForChild("SellItems", 10)
local PlantSeed         = RemoteEvents and RemoteEvents:WaitForChild("PlantSeed", 10)
local GetAvailablePlots = RemoteEvents and RemoteEvents:WaitForChild("GetAvailablePlots", 10)
local GetShopData       = RemoteEvents and RemoteEvents:WaitForChild("GetShopData", 10)
local RedeemCode        = RemoteEvents and RemoteEvents:WaitForChild("RedeemCode", 10)
local RequestCellData   = RemoteEvents and RemoteEvents:WaitForChild("RequestCellData", 10)
local BotanistRequest   = RemoteEvents and RemoteEvents:WaitForChild("BotanistRequest", 10)
local BotanistQuestRequest = RemoteEvents and RemoteEvents:WaitForChild("BotanistQuestRequest", 10)

local CFG_FILE = "CloudyzHub_v10_final.json"
local defaultConfig = {
    autoPlant = false,   plantSeedMode = "Seed in Inv", selectedSeeds = {}, selectedSeedsFull = {},
    plantInterval = 0.1, plantAmount = 1,
    autoSell = false,    sellInterval = 60,
    autoBuySeed = false, selectedBuySeeds = {},  buySeedInterval = 20, buySeedAmount = 1,
    autoWater = false,   waterMode = "All",      selectedWaterPlants = {}, waterInterval = 3,
    autoSprinkler = false, sprinklerName = "Basic Sprinkler", sprinklerPutMode = "Random", sprinklerInterval = 10,
    autoBuyGear = false, selectedGear = {},      buyGearInterval = 20, buyGearAmount = 1,
    autoCollect = false, collectMode = "All",    selectedCollectPlants = {}, collectInterval = 0.05,
    filterMutations = {},
    fpsBoostLevel = "Off", autoRejoin = false,   autoClaimPlot = false,
    autoTPGarden = false, tpGardenInterval = 60,
    selectedDeletePlant = "",
    autoDeletePlant = false, deleteInterval = 10,
    walkSpeed = 16, jumpPower = 7.2, fly = false, flySpeed = 50,
    infMoney = false,
    autoQuest = false, questType = "Daily", selectedQuests = {},
    autoClaimQuestReward = false,
    autoSaveConfig = true,
    savedConfigs = {},
    selectedConfigName = "",
    invFullThreshold = 245,
    autoFavoriteType = "Seed", selectedFavoritePlant = "", autoFavorite = false,
    autoAppraise = false, appraiseMutations = {}, appraiseInterval = 1,
    autoMaraQuest = false, maraQuestInterval = 5,
    autoOpenPack = false, selectedPack = "Gardener Seed Pack", packOpenInterval = 1.5,
    espEnabled = false, espMode = "Fruit ESP", espSelectedMutation = "",
    espAllInventory = false,
    giveSeedName = "Carrot Seed", giveSeedAmount = 1,
}
local Config = table.clone(defaultConfig)

local function canFS()
    return type(writefile) == "function" and type(readfile) == "function" and type(isfile) == "function"
end
local function safeWrite(path, content) if not canFS() then return false end; return pcall(function() writefile(path, content) end) end
local function safeRead(path) if not canFS() then return nil end; local ok, r = pcall(function() return readfile(path) end); return ok and r or nil end
local function safeIsFile(path) if not canFS() then return false end; local ok, r = pcall(function() return isfile(path) end); return ok and r == true end

local function saveConfig()
    if not Config.autoSaveConfig then return end
    local ok, enc = pcall(function() return HttpService:JSONEncode(Config) end)
    if ok then safeWrite(CFG_FILE, enc) end
end
local function saveConfigForce()
    local ok, enc = pcall(function() return HttpService:JSONEncode(Config) end)
    if ok then safeWrite(CFG_FILE, enc) end
end
local function loadConfig()
    local content = safeIsFile(CFG_FILE) and safeRead(CFG_FILE) or nil
    if content then
        pcall(function()
            local d = HttpService:JSONDecode(content)
            for k, v in pairs(d) do if Config[k] ~= nil then Config[k] = v end end
        end)
    end
end
loadConfig()
for _, k in ipairs({ "selectedSeeds", "selectedSeedsFull", "selectedBuySeeds", "selectedWaterPlants",
                     "selectedCollectPlants", "filterMutations", "selectedQuests", "selectedGear", "savedConfigs", "appraiseMutations" }) do
    if type(Config[k]) ~= "table" then Config[k] = {} end
end
Config.questType = "Daily"

local _toggleRefs = {}
local MainUI, MiniUI, StatusLabel = nil, nil, nil
local NotifQ, NotifActive = {}, false

local function showNotif(title, msg, dur)
    dur = dur or 1.5
    table.insert(NotifQ, { t = title, m = msg, d = dur })
    if NotifActive then return end
    NotifActive = true
    task.spawn(function()
        while #NotifQ > 0 do
            local n = table.remove(NotifQ, 1)
            pcall(function()
                local sg = Instance.new("ScreenGui"); sg.Name = "N_" .. tick(); sg.ResetOnSpawn = false
                sg.ZIndexBehavior = Enum.ZIndexBehavior.Sibling; sg.Parent = CoreGui
                local fr = Instance.new("Frame", sg)
                fr.Size = UDim2.new(0, 300, 0, 68); fr.Position = UDim2.new(1, 20, 0.85, 0)
                fr.BackgroundColor3 = Color3.fromRGB(13, 14, 17); fr.BorderSizePixel = 0
                Instance.new("UICorner", fr).CornerRadius = UDim.new(0, 10)
                local s = Instance.new("UIStroke", fr); s.Color = Color3.fromRGB(120, 130, 145); s.Thickness = 1.5
                local t1 = Instance.new("TextLabel", fr); t1.Size = UDim2.new(1, -10, 0, 20); t1.Position = UDim2.new(0, 6, 0, 5)
                t1.BackgroundTransparency = 1; t1.Text = n.t; t1.TextColor3 = Color3.fromRGB(170, 178, 190)
                t1.Font = Enum.Font.GothamBold; t1.TextSize = 12; t1.TextXAlignment = Enum.TextXAlignment.Left
                local t2 = Instance.new("TextLabel", fr); t2.Size = UDim2.new(1, -10, 0, 36); t2.Position = UDim2.new(0, 6, 0, 26)
                t2.BackgroundTransparency = 1; t2.Text = n.m; t2.TextColor3 = Color3.fromRGB(185, 188, 195)
                t2.Font = Enum.Font.Gotham; t2.TextSize = 11; t2.TextWrapped = true; t2.TextXAlignment = Enum.TextXAlignment.Left
                TweenService:Create(fr, TweenInfo.new(0.2, Enum.EasingStyle.Back), { Position = UDim2.new(1, -310, 0.85, 0) }):Play()
                task.wait(n.d)
                TweenService:Create(fr, TweenInfo.new(0.18), { Position = UDim2.new(1, 20, 0.85, 0) }):Play()
                task.wait(0.2); sg:Destroy()
            end)
            task.wait(0.18)
        end
        NotifActive = false
    end)
end
local function notifyTog(name, en) showNotif(name, en and "Enabled" or "Disabled", 1) end
local function warnTPGarden() showNotif("Reminder", "Please go into your garden/turn on Auto TP garden if this doesnt work.", 3.5) end

local _currentMaraQuestMutations = {}
local loops = {}
local function stopLoop(name) loops[name] = false end
local function startLoop(name, interval, fn)
    stopLoop(name); loops[name] = true
    task.spawn(function()
        while loops[name] do
            if not loops[name] then break end
            pcall(fn)
            task.wait(interval)
        end
    end)
end

local _npcMutex=false
local function waitNpcMutex(timeout)
    local t=tick()
    while _npcMutex and tick()-t<(timeout or 8) do task.wait(0.05) end
end
local function acquireNpcMutex(timeout) 
    timeout = timeout or 8; local t = tick()
    while _npcMutex do if tick() - t > timeout then return false end; task.wait(0.05) end
    _npcMutex = true; return true
end
local function releaseNpcMutex() _npcMutex=false end

local function getHRP() local c = plr.Character; return c and c:FindFirstChild("HumanoidRootPart") end
local function tpTo(pos) local h = getHRP(); if h then h.CFrame = CFrame.new(pos) end end
local function tpCF(cf)  local h = getHRP(); if h then h.CFrame = cf end end

local _toolMutex = false
local function acquireToolMutex(timeout)
    timeout = timeout or 5; local t = tick()
    while _toolMutex do if tick() - t > timeout then return false end; task.wait(0.05) end
    _toolMutex = true; return true
end
local function releaseToolMutex() _toolMutex = false end

local function unequipAll()
    local c = plr.Character; if not c then return end
    for _, item in pairs(c:GetChildren()) do
        if item:IsA("Tool") then pcall(function() item.Parent = plr.Backpack end) end
    end
    task.wait(0.05)
end

local function getInv()
    local inv = {}
    local bp = plr:FindFirstChild("Backpack")
    if bp then for _, i in pairs(bp:GetChildren()) do if i:IsA("Tool") then table.insert(inv, i) end end end
    local c = plr.Character
    if c then for _, i in pairs(c:GetChildren()) do if i:IsA("Tool") then table.insert(inv, i) end end end
    return inv
end
local function getInvCount()
    local count = 0
    local bp = plr:FindFirstChild("Backpack")
    if bp then
        for _, i in pairs(bp:GetChildren()) do
            if i:IsA("Tool") then
                local amt = i:GetAttribute("Amount") or i:GetAttribute("ItemCount")
                count = count + (amt and type(amt) == "number" and amt > 1 and amt or 1)
            end
        end
    end
    local c = plr.Character
    if c then for _, i in pairs(c:GetChildren()) do if i:IsA("Tool") then count = count + 1 end end end
    return count
end
local function isInvFull() return getInvCount() >= Config.invFullThreshold end
local function countSeeds(seedName)
    local count = 0
    for _, item in pairs(getInv()) do
        local bn = item:GetAttribute("BaseName")
        if bn == seedName then count = count + (item:GetAttribute("Amount") or item:GetAttribute("ItemCount") or 1) end
    end
    return count
end
local function getSeedNames()
    local r, added = {}, {}
    for _, i in pairs(getInv()) do
        local bn = i:GetAttribute("BaseName"); local t = i:GetAttribute("Type")
        if t == "Seeds" and bn and not added[bn] then table.insert(r, bn); added[bn] = true end
    end
    return r
end
local function getSeedTool(n)
    local bp = plr:FindFirstChild("Backpack")
    if bp then for _, i in pairs(bp:GetChildren()) do if i:GetAttribute("BaseName") == n then return i end end end
    local c = plr.Character
    if c then for _, i in pairs(c:GetChildren()) do if i:IsA("Tool") and i:GetAttribute("BaseName") == n then return i end end end
end
local function isFav(item) return item:GetAttribute("Favorited") == true or item:GetAttribute("IsFavorite") == true end
local function equipTool(t)
    local c = plr.Character; if not c then return end
    if t.Parent ~= plr.Backpack then pcall(function() t.Parent = plr.Backpack end); task.wait(0.05) end
    for _, item in pairs(c:GetChildren()) do
        if item:IsA("Tool") and item ~= t then pcall(function() item.Parent = plr.Backpack end) end
    end
    task.wait(0.05); pcall(function() t.Parent = c end)
end
local function unequipTool(t) pcall(function() t.Parent = plr.Backpack end); task.wait(0.05) end
local function hasWaterCan()
    for _, i in pairs(getInv()) do
        local bn = i:GetAttribute("BaseName")
        if bn and bn:find("Watering Can") then return true, i end
    end
    return false, nil
end
local function getShovelTool()
    local bp = plr:FindFirstChild("Backpack")
    if bp then for _, i in pairs(bp:GetChildren()) do if i.Name == "Shovel" or i:GetAttribute("BaseName") == "Shovel" then return i end end end
end

-- ==================== PLANT DATA (CONFIRMED FROM SCAN) ====================
-- PlantDataDefinitions has: FruitBaseValue (multi-fruit), PlantBaseValue (single-harvest)
-- FruitBaseWeight, PlantBaseWeight, Rarity etc.
-- Formula: floor(FruitBaseValue * HiddenNumber^2 * RipenessMultiplier)
-- Confirmed: backpack tools already have FruitValue attribute set by server

local PlantDataDefs = nil
task.spawn(function()
    pcall(function()
        local defs = RS:FindFirstChild("Plants") and RS.Plants:FindFirstChild("Definitions")
        if defs then
            local pdd = defs:FindFirstChild("PlantDataDefinitions")
            if pdd then PlantDataDefs = require(pdd) end
        end
    end)
end)

-- FIXED: correct value formula using confirmed scan data
local function getSellMultiplier()
    local mult = 1
    pcall(function()
        local fb = plr.PlayerGui:FindFirstChild("Friend Boost", true)
        if not fb then
            local mg = plr.PlayerGui:FindFirstChild("MainGui", true)
            if mg then fb = mg:FindFirstChild("Friend Boost", true) end
        end
        if fb and fb:IsA("TextLabel") and fb.Text:find("%%") then
            local p = fb.Text:match("%+(%d+)%%")
            if p then mult = mult + (tonumber(p)/100) end
        end
    end)
    return mult
end

local function calcFruitValue(plantType, hiddenNumber, ripMult)
    local def = PlantDataDefs and PlantDataDefs[plantType]
    if not def then return 1 end
    local baseVal = def.FruitBaseValue or def.PlantBaseValue or 1
    -- Server formula: floor(FruitBaseValue * HiddenNumber^2 * RipenessMultiplier)
    return math.max(1, math.floor(baseVal * hiddenNumber * hiddenNumber * ripMult))
end

-- FIXED: world fruit value estimation
local function estimateFruitValue(fruit, plantType)
    -- HiddenNumber = FruitScale on the fruit model (confirmed in scan)
    local hiddenNumber = fruit:GetAttribute("HiddenNumber")
        or fruit:GetAttribute("FruitScale")
        or 1
    local ripMult = fruit:GetAttribute("RipenessMultiplier") or 1
    local baseValue = calcFruitValue(plantType, hiddenNumber, ripMult)
    return math.floor(baseValue * getSellMultiplier())
end

local function getGrowthPercent(plant)
    local gh = plant:GetAttribute("GrowthHealth") or 0
    local gm = plant:GetAttribute("GrowthMaxHealth") or 1
    if gm == 0 then return 100 end
    return math.floor((gh / gm) * 100)
end

local function getMutationsString(fruit)
    local mut = fruit:GetAttribute("Mutation") or ""
    local parts = {}
    if mut ~= "" then
        for m in mut:gmatch("[^,]+") do
            local trimmed = m:match("^%s*(.-)%s*$")
            if trimmed ~= "" then table.insert(parts, trimmed) end
        end
    end
    return parts
end

local function getAllSeedNames()
    local names, added = {}, {}
    local nonSeedPatterns = {"controller","cutscene","rainlb","shopdata","seedbegin","^seeds$","seedtype","seedbox"}
    local function isValidSeedName(n)
        local lc = n:lower()
        if not lc:find("seed") then return false end
        if lc:find("pack") then return false end
        for _, pat in ipairs(nonSeedPatterns) do if lc:find(pat) then return false end end
        return true
    end
    local plants = RS:FindFirstChild("Plants")
    if plants then
        local models = plants:FindFirstChild("Models")
        if models then
            for _, item in pairs(models:GetChildren()) do
                local n = item.Name
                if isValidSeedName(n) and not added[n] then table.insert(names, n); added[n] = true end
            end
        end
        for _, item in pairs(plants:GetChildren()) do
            local n = item.Name
            if isValidSeedName(n) and not added[n] then table.insert(names, n); added[n] = true end
        end
    end
    if #names == 0 then
        for _, item in pairs(RS:GetDescendants()) do
            local n = item.Name
            if isValidSeedName(n) and not added[n] and #n > 4 then table.insert(names, n); added[n] = true end
        end
    end
    local baseSeeds = { "Carrot Seed", "Corn Seed", "Wheat Seed", "Tomato Seed", "Potato Seed", "Strawberry Seed", "Cabbage Seed", "Pumpkin Seed", "Watermelon Seed", "Blueberry Seed", "Apple Seed", "Bamboo Seed", "Cactus Seed", "Mushroom Seed", "Grape Seed", "Mango Seed", "Pepper Seed", "Onion Seed", "Sunflower Seed", "Rose Seed", "Dandelion Seed", "Sunpetal Seed", "Goldenberry Seed", "Birch Seed", "Amberpine Seed", "Beetroot Seed" }
    for _, n in pairs(baseSeeds) do if not added[n] then table.insert(names, n); added[n] = true end end
    table.sort(names)
    return names
end
local _allSeedCache = nil
local function getAllSeedNamesCached() if not _allSeedCache then _allSeedCache = getAllSeedNames() end; return _allSeedCache end
local SHOP_SEED_LIST = {
    "Cherry Seed", "Cabbage Seed", "Potato Seed", "Plum Seed", "Banana Seed", 
    "Wheat Seed", "Rose Seed", "Apple Seed", "Tomato Seed", "Beetroot Seed", 
    "Mushroom Seed", "Strawberry Seed", "Onion Seed", "Corn Seed", "Carrot Seed",
    "Mango Seed", "Bamboo Seed"
}
local SPRINKLER_LIST = { "Basic Sprinkler", "Super Sprinkler", "Turbo Sprinkler" }
local GEAR_LIST = { "Watering Can", "Favorite Tool", "Basic Sprinkler", "Super Sprinkler", "Turbo Sprinkler", "Harvest Bell", "Trowel" }
local SEED_PACK_LIST = { "Gardener Seed Pack", "Dawn Seed Pack", "Premium Gardener Seed Pack", "Premium Dawn Seed Pack" }
local MUTATION_LIST = { "Lush", "Gold", "Silver", "Starstruck", "Shocked", "Frostbit", "Snowy", "Chilled", "Flooded", "Soaked", "Sandy", "Foggy", "Ripened", "Unripe" }

local function fruitHasMutation(model, selectedMutations)
    if not selectedMutations or #selectedMutations == 0 then return true end
    local mutAttr = model:GetAttribute("Mutation") or ""
    local ripenessStage = model:GetAttribute("RipenessStage") or ""
    local variant = model:GetAttribute("Variant") or ""
    for _, mut in pairs(selectedMutations) do
        if mutAttr:find(mut, 1, true) then return true end
        if ripenessStage == mut then return true end
        if variant == mut then return true end
    end
    return false
end

local function getPlot()
    local pf = Workspace:FindFirstChild("Plots"); if not pf then return nil end
    for _, p in pairs(pf:GetChildren()) do
        if not p:IsA("Model") then continue end
        if p:GetAttribute("Owner") == plr.UserId then return p end
        local ov = p:FindFirstChild("Owner")
        if ov and ov:IsA("StringValue") and (ov.Value == plr.Name or ov.Value == tostring(plr.UserId)) then return p end
    end
end
local function hasPlot() return getPlot() ~= nil end
local function getGardenPosition()
    local plot = getPlot(); if not plot then return nil end
    local cf, _ = plot:GetBoundingBox(); return cf.Position
end
local function isInGarden()
    local hrp = getHRP(); if not hrp then return false end
    local gp = getGardenPosition(); if not gp then return false end
    return (hrp.Position - gp).Magnitude < 80
end

local function getPlantDisplayName(model)
    local bn = model:GetAttribute("BaseName")
    if bn and not bn:match("^%a+%d+$") then return bn end
    local pt2 = model:GetAttribute("PlantType")
    if pt2 then return pt2 end
    local pt = model:GetAttribute("PlantTemplateName")
    if pt then local s = pt:match("^([%a%s]+)%d*$"); if s then return s end end
    local ct = model:GetAttribute("CropType") or model:GetAttribute("PlantType")
    if ct then return ct end
    local s = model.Name:match("^([%a%s]+)%d*$"); return s or model.Name
end

local function findHarvestPrompt(model)
    for _, c in pairs(model:GetDescendants()) do
        if c:IsA("ProximityPrompt") and c.Name == "HarvestPrompt" then return c end
    end
    for _, c in pairs(model:GetDescendants()) do
        if c:IsA("ProximityPrompt") then return c end
    end
    return nil
end

local _patchedPrompts = {}
local function patchPrompt(prompt)
    if not prompt or not prompt:IsA("ProximityPrompt") then return end
    if _patchedPrompts[prompt] then return end
    pcall(function() prompt.HoldDuration = 0 end)
    pcall(function() prompt.MaxActivationDistance = 999999 end)
    pcall(function() prompt.RequiresLineOfSight = false end)
    _patchedPrompts[prompt] = true
end

local function tpToNPCReady(folderName, npcName, offset, timeout)
    offset = offset or 4; timeout = timeout or 8
    local function findNPCRoot()
        local phys = Workspace:FindFirstChild("MapPhysical")
        if not phys then return nil, nil end
        local shops = phys:FindFirstChild("Shops")
        if shops then
            local folder = shops:FindFirstChild(folderName)
            if folder then
                local npc = folder:FindFirstChild(npcName)
                if npc then return npc, npc:FindFirstChild("HumanoidRootPart") or npc.PrimaryPart end
            end
        end
        local f2 = phys:FindFirstChild(folderName)
        if f2 then
            local n2 = f2:FindFirstChild(npcName)
            if n2 then return n2, n2:FindFirstChild("HumanoidRootPart") or n2.PrimaryPart end
        end
        return nil, nil
    end
    local npc, root = findNPCRoot()
    if npc and root then tpCF(root.CFrame * CFrame.new(0, 0, offset)); task.wait(0.5); return true end
    local t = tick()
    repeat
        task.wait(0.25); npc, root = findNPCRoot()
        if npc and root then tpCF(root.CFrame * CFrame.new(0, 0, offset)); task.wait(0.5); return true end
    until tick() - t > timeout
    return false
end

local function doTPGarden()
    local gp = getGardenPosition()
    if not gp then showNotif("TP Garden", "No garden found!", 2); return end
    tpTo(gp + Vector3.new(0, 5, 0))
    if SetStreamFocus then pcall(function() SetStreamFocus:FireServer("start", gp) end) end
end

local function calcGardenCenter()
    local clientPlants = Workspace:FindFirstChild("ClientPlants")
    if not clientPlants then return nil end
    local sumX, sumY, sumZ, count = 0, 0, 0, 0
    for _, p in pairs(clientPlants:GetChildren()) do
        if not p:IsA("Model") then continue end
        local pgp = p:GetAttribute("PlantGroundPosition")
        if pgp and typeof(pgp) == "string" then
            local parts = pgp:split(",")
            if #parts == 3 then
                local x, y, z = tonumber(parts[1]:match("[%d%.%-]+")), tonumber(parts[2]:match("[%d%.%-]+")), tonumber(parts[3]:match("[%d%.%-]+"))
                if x and y and z then sumX = sumX + x; sumY = sumY + y; sumZ = sumZ + z; count = count + 1; continue end
            end
        end
        local pp = p.PrimaryPart or p:FindFirstChildOfClass("BasePart")
        if pp and pp.Position.Magnitude > 1 then
            sumX = sumX + pp.Position.X; sumY = sumY + pp.Position.Y; sumZ = sumZ + pp.Position.Z; count = count + 1
        end
    end
    if count > 0 then return Vector3.new(sumX / count, sumY / count + 3, sumZ / count) end
    local plot = getPlot()
    if plot then local ok, cf = pcall(function() return plot:GetBoundingBox() end); if ok and cf then return cf.Position + Vector3.new(0, 3, 0) end end
    return nil
end

local autoCollectRunning = false
local function autoCollect()
    if autoCollectRunning then return end
    if not Config.autoCollect then return end
    if _sellLock or _toolMutex then return end
    waitSellDone()
    autoCollectRunning = true
    
    pcall(function()
        local clientPlants = Workspace:FindFirstChild("ClientPlants")
        if not clientPlants then return end
    local function shouldCollectByName(name)
        if Config.collectMode == "All" then return true end
        for _, s in pairs(Config.selectedCollectPlants) do if s == name then return true end end
        return false
    end
        local hrpRef = getHRP()
        if not hrpRef then return end
        
        local function hasMaraMut(model)
            if not Config.autoCompleteMara then return false end
            for _, m in ipairs(_currentMaraQuestMutations) do
                if fruitHasMutation(model, {m}) then return true end
            end
            return false
        end

        local needsCollect = false
        for _, plantModel in pairs(clientPlants:GetChildren()) do
            if not plantModel:IsA("Model") then continue end
            if plantModel:GetAttribute("OwnerUserId") ~= plr.UserId then continue end
            if plantModel:GetAttribute("HarvestablePlant") then
                if plantModel:GetAttribute("FullyGrown") and (fruitHasMutation(plantModel, Config.filterMutations) or hasMaraMut(plantModel)) and shouldCollectByName(getPlantDisplayName(plantModel)) then needsCollect = true; break end
            else
                for _, child in pairs(plantModel:GetChildren()) do
                    if child:IsA("Model") and child.Name:match("^Fruit") and child:GetAttribute("FullyGrown") and (fruitHasMutation(child, Config.filterMutations) or hasMaraMut(child)) and shouldCollectByName(getPlantDisplayName(plantModel)) then needsCollect = true; break end
                end
            end
            if needsCollect then break end
        end
        if not needsCollect then autoCollectRunning = false; return end

        if not acquireToolMutex(2) then autoCollectRunning = false; return end
        local origCF = hrpRef.CFrame
    local iv = Config.collectInterval
    if iv <= 0 then iv = 0.05 end
    local MAX_PLANT_DIST = 50
    local gardenCenter = calcGardenCenter() or origCF.Position
    hrpRef.CFrame = CFrame.new(gardenCenter); task.wait(0.25)
    local targets = {}
    local function getTargetPos(model)
        if not model or not model.Parent then return nil end
        local root = model:FindFirstChild("FruitAnchor") or model:FindFirstChild("HarvestBoundingPart") or model.PrimaryPart or model:FindFirstChildOfClass("BasePart")
        return root and root.Position or nil
    end
    local snapshot = {}
    for _, child in pairs(clientPlants:GetChildren()) do if child:IsA("Model") then table.insert(snapshot, child) end end
    for _, plantModel in pairs(snapshot) do
        if not Config.autoCollect or _sellLock then break end
        if not plantModel or not plantModel.Parent then continue end
        local plantName = getPlantDisplayName(plantModel)
        if not shouldCollectByName(plantName) then continue end
        local plantUuid = plantModel:GetAttribute("Uuid")
        if not plantUuid then continue end
        local isHarvestable = plantModel:GetAttribute("HarvestablePlant")
        if isHarvestable then
            if not plantModel:GetAttribute("FullyGrown") then continue end
            if not fruitHasMutation(plantModel, Config.filterMutations) and not hasMaraMut(plantModel) then continue end
            local pos = getTargetPos(plantModel)
            if pos and (pos - gardenCenter).Magnitude <= MAX_PLANT_DIST then
                table.insert(targets, { pos = pos, payload = { Uuid = plantUuid } })
            end
            continue
        end
        for _, child in pairs(plantModel:GetChildren()) do
            if not Config.autoCollect or _sellLock then break end
            if not child:IsA("Model") or not child.Name:match("^Fruit") then continue end
            if not child:GetAttribute("FullyGrown") then continue end
            if not fruitHasMutation(child, Config.filterMutations) and not hasMaraMut(child) then continue end
            local gai = child:GetAttribute("GrowthAnchorIndex")
            if gai == nil then continue end
            local pos = getTargetPos(child)
            if pos and (pos - gardenCenter).Magnitude <= MAX_PLANT_DIST then
                table.insert(targets, { pos = pos, payload = { GrowthAnchorIndex = gai, Uuid = plantUuid } })
            end
        end
    end
    local BATCH_SIZE = 10; local BATCH_RADIUS = 8
    while #targets > 0 and Config.autoCollect and not _npcMutex do
        local centerTarget = targets[1]
        local batchPayload = {}; local keepTargets = {}
        for i, t in ipairs(targets) do
            if #batchPayload < BATCH_SIZE and (t.pos - centerTarget.pos).Magnitude <= BATCH_RADIUS then
                table.insert(batchPayload, t.payload)
            else table.insert(keepTargets, t) end
        end
        local h = getHRP()
        if h then
            h.CFrame = CFrame.new(centerTarget.pos + Vector3.new(0, 2, 0))
            local ping = 0.1; pcall(function() ping = game:GetService("Stats").Network.ServerStatsItem["Data Ping"]:GetValue() / 1000 end)
            task.wait(math.clamp(ping + 0.1, 0.25, 0.5))
        end
        if HarvestFruit and #batchPayload > 0 then pcall(function() HarvestFruit:FireServer(batchPayload) end) end
        task.wait(0.12); targets = keepTargets
    end
        local hrpFinal = getHRP(); if hrpFinal and not _npcMutex then hrpFinal.CFrame = origCF end
    end)
    releaseToolMutex()
    autoCollectRunning = false
end

local VALID_SHOP_SEEDS = {
    "Cherry Seed", "Cabbage Seed", "Potato Seed", "Plum Seed", "Banana Seed", 
    "Wheat Seed", "Rose Seed", "Apple Seed", "Tomato Seed", "Beetroot Seed", 
    "Mushroom Seed", "Strawberry Seed", "Onion Seed", "Corn Seed", "Carrot Seed",
    "Mango Seed", "Bamboo Seed"
}

local buySeedRunning = false
local buyGearRunning = false

local function doBuySeedBulk(seedList, amount, silent)
    if buySeedRunning then 
        warn("[BuySeed] Blocked: Already running")
        return 
    end
    if not acquireNpcMutex(8) then return end
    buySeedRunning = true
    
    local finalOk, finalErr = pcall(function()
        if not seedList or #seedList == 0 then warn("[BuySeed] Error: No seeds selected"); return end
        if not PurchaseShopItem then warn("[BuySeed] Error: No remote found"); return end
        
        local validSeeds = {}
        for _, seed in pairs(seedList) do
            for _, valid in pairs(VALID_SHOP_SEEDS) do
                if seed == valid then table.insert(validSeeds, seed); break end
            end
        end
        
        if #validSeeds == 0 then
            warn("[BuySeed] Error: Filter left 0 valid seeds")
            if not silent then showNotif("Buy Seed", "No valid shop seeds selected!", 2) end
            return
        end
        
        local isMax = amount >= 51
        local hrp = getHRP()
        if not hrp then warn("[BuySeed] Error: No HRP"); return end
        
        local origCF = hrp.CFrame
        local npcReady = tpToNPCReady("Seed Shop", "SeedNPC", 5, 8)
        if not npcReady then
            warn("[BuySeed] Error: NPC not loaded")
            tpCF(origCF)
            return
        end
        
        task.wait(0.2)
        local boughtCount = 0
        
        for i = 1, (isMax and 50 or amount) do
            if silent and not Config.autoBuySeed then break end
            
            for _, seedName in pairs(validSeeds) do
                task.spawn(function()
                    pcall(function() PurchaseShopItem:InvokeServer("SeedShop", seedName) end)
                end)
            end
            task.wait(0.01)
        end
        boughtCount = #validSeeds
        
        task.wait(0.1)
        tpCF(origCF)
        if not silent then showNotif("Buy Seed", "Bought " .. boughtCount .. " seed type(s)", 1.5) end
    end)
    
    releaseNpcMutex()
    buySeedRunning = false
end

local function doBuyGearBulk(gearList, amount, silent)
    if buyGearRunning then 
        warn("[BuyGear] Blocked: Already running")
        return 
    end
    if not acquireNpcMutex(8) then return end
    buyGearRunning = true
    
    local finalOk, finalErr = pcall(function()
        if not gearList or #gearList == 0 then warn("[BuyGear] Error: No gear selected"); return end
        if not PurchaseShopItem then warn("[BuyGear] Error: No remote found"); return end
        
        local isMax = amount >= 51
        local hrp = getHRP()
        if not hrp then warn("[BuyGear] Error: No HRP"); return end
        
        local origCF = hrp.CFrame
        local npcReady = tpToNPCReady("Gear Shop", "GearNPC", 5, 8)
        if not npcReady then
            warn("[BuyGear] Error: NPC not loaded")
            tpCF(origCF)
            return
        end
        
        task.wait(0.2)
        local boughtCount = 0
        
        for i = 1, (isMax and 50 or amount) do
            if silent and not Config.autoBuyGear then break end
            
            for _, gearName in pairs(gearList) do
                task.spawn(function()
                    pcall(function() PurchaseShopItem:InvokeServer("GearShop", gearName) end)
                end)
            end
            task.wait(0.01)
        end
        boughtCount = #gearList
        
        task.wait(0.1)
        tpCF(origCF)
        if not silent then showNotif("Buy Gear", "Bought " .. boughtCount .. " gear type(s)", 1.5) end
    end)
    
    releaseNpcMutex()
    buyGearRunning = false
end

local autoSellRunning=false
local function doSell()
    if autoSellRunning then return false end
    if not SellItems then return false end
    local hrp=getHRP(); if not hrp then return false end
    local hasSellable=false
    for _,i in pairs(getInv()) do
        if i:GetAttribute("Type")=="Plants" and not isFav(i) then hasSellable=true; break end
    end
    if not hasSellable then return false end
    autoSellRunning=true
    if not acquireNpcMutex(8) then autoSellRunning=false; return false end
    local origCF=hrp.CFrame
    local npcReady = tpToNPCReady("Sell Stand", "Steve", 3, 8)
    if not npcReady then
        tpCF(origCF); releaseNpcMutex(); autoSellRunning=false
        showNotif("Sell Failed","Steve NPC not loaded",2); return false
    end
    
    -- WAIT FOR SERVER TO REGISTER THE TP BEFORE SELLING
    task.wait(0.03) 

    local ok,res=pcall(function() return SellItems:InvokeServer("SellAll") end)
    
    -- WAIT FOR SERVER TO PROCESS THE SELL BEFORE TPING BACK
    task.wait(0.1)
    
    tpCF(origCF)
    task.wait(0.1)
    releaseNpcMutex(); autoSellRunning=false
    
    if ok then 
        showNotif("Sell",type(res)=="string" and res:sub(1,50) or "Sold!",1.5)
        return true 
    end
    return false
end



local function getFavoriteTool()
    for _, item in pairs(getInv()) do
        local bn = item:GetAttribute("BaseName") or item.Name
        if bn == "Favorite Tool" then return item end
    end
    return nil
end

-- ==================== FIXED: doAutoFavorite ====================
-- Seed type: UseGear:FireServer(gearName, {PlantUuid=..., GrowthAnchorIndex=...}) - NO teleport
-- Plant type: ToggleFavoriteEv:FireServer(toolInstance) - pass instance directly (confirmed from hook)
local function doAutoFavorite()
    if not Config.autoFavorite then return end
    local selected = Config.selectedFavoritePlant
    if not selected or selected == "" then return end
    local typ = Config.autoFavoriteType

    if typ == "Seed" then
        -- Favorite fruits on growing plants using UseGear remote (no teleport needed)
        if not UseGear then
            showNotif("Auto Favorite", "UseGear remote not found!", 2)
            return
        end
        local favToolItem = getFavoriteTool()
        if not favToolItem then
            showNotif("Auto Favorite", "No Favorite Tool in backpack!", 2)
            return
        end
        -- Equip the tool properly using Humanoid
        local hum = plr.Character and plr.Character:FindFirstChild("Humanoid")
        if hum then
            pcall(function() hum:EquipTool(favToolItem) end)
            task.wait(0.3)
        end
        -- GearName to pass to server (from attribute or fallback)
        local gearName = favToolItem:GetAttribute("GearName") or "Favorite Tool"
        -- Strip " Seed" suffix if present (e.g., "Corn Seed" -> "Corn")
        local plantTypeName = selected:gsub(" Seed$", "")
        local clientPlants = Workspace:FindFirstChild("ClientPlants")
        if not clientPlants then return end

        for _, plantModel in pairs(clientPlants:GetChildren()) do
            if not Config.autoFavorite then break end
            if plantModel:GetAttribute("PlantType") ~= plantTypeName then continue end
            if plantModel:GetAttribute("OwnerUserId") ~= plr.UserId then continue end
            local plantUuid = plantModel:GetAttribute("Uuid")
            if not plantUuid then continue end

            if plantModel:GetAttribute("HarvestablePlant") then
                -- Single-harvest plant (Carrot, Onion, Beetroot, etc.)
                -- Check Favorited attribute (set by server after favoring)
                if plantModel:GetAttribute("FullyGrown") and not plantModel:GetAttribute("Favorited") then
                    pcall(function()
                        UseGear:FireServer(gearName, {
                            PlantUuid = plantUuid,
                            GrowthAnchorIndex = nil
                        })
                    end)
                    task.wait(0.15)
                end
            else
                -- Multi-fruit plant: iterate each fruit child
                for _, fruit in pairs(plantModel:GetChildren()) do
                    if not Config.autoFavorite then break end
                    if not fruit:IsA("Model") then continue end
                    if not fruit:GetAttribute("FullyGrown") then continue end
                    if fruit:GetAttribute("Favorited") then continue end -- already favorited
                    local anchorIdx = fruit:GetAttribute("GrowthAnchorIndex")
                    pcall(function()
                        UseGear:FireServer(gearName, {
                            PlantUuid = plantUuid,
                            GrowthAnchorIndex = anchorIdx
                        })
                    end)
                    task.wait(0.15)
                end
            end
        end

    elseif typ == "Plant" then
        -- FIXED: ToggleFavorite takes the tool INSTANCE directly (confirmed from hook scan)
        -- Hook output: "Arg1: Corn (0.20 KG) (Instance)"
        if not ToggleFavoriteEv then
            showNotif("Auto Favorite", "ToggleFavorite remote not found!", 2)
            return
        end
        for _, item in pairs(getInv()) do
            if not Config.autoFavorite then break end
            if item:GetAttribute("Type") ~= "Plants" then continue end
            local bn = item:GetAttribute("BaseName") or item.Name
            if bn ~= selected then continue end
            if isFav(item) then continue end -- already favorited
            
            local uuid = item:GetAttribute("Uuid") or item:GetAttribute("UUID")
            if not uuid then continue end
            
            pcall(function()
                ToggleFavoriteEv:FireServer(item)
            end)
            task.wait(0.15)
        end
    end
end

local function getClientPlantTypes()
    local r, added = {}, {}
    local clientPlants = Workspace:FindFirstChild("ClientPlants")
    if not clientPlants then return r end
    for _, p in pairs(clientPlants:GetChildren()) do
        if p:IsA("Model") then
            local pt = p:GetAttribute("PlantType")
            if pt and not added[pt] then table.insert(r, pt .. " Seed"); added[pt] = true end
        end
    end
    table.sort(r); return r
end

local function getInventoryPlantNames()
    local r, added = {}, {}
    for _, item in pairs(getInv()) do
        local t = item:GetAttribute("Type")
        local bn = item:GetAttribute("BaseName") or item.Name
        if t == "Plants" and bn and not added[bn] then table.insert(r, bn); added[bn] = true end
    end
    table.sort(r); return r
end


local function doAutoOpenPack()
    if not Config.autoOpenPack then return end
    local packName = Config.selectedPack
    if not packName or packName == "" then return end
    local packTool = nil
    for _, item in pairs(getInv()) do
        local bn = item:GetAttribute("BaseName") or item.Name
        if bn == packName then packTool = item; break end
    end
    if not packTool then return end
    local char = plr.Character; if not char then return end
    if packTool.Parent ~= char then
        pcall(function() packTool.Parent = plr.Backpack end); task.wait(0.05)
        for _, item in pairs(char:GetChildren()) do
            if item:IsA("Tool") then pcall(function() item.Parent = plr.Backpack end) end
        end
        pcall(function() packTool.Parent = char end); task.wait(0.2)
    end
    pcall(function() packTool:Activate() end)
    task.wait(0.1)
    for _, d in pairs(packTool:GetDescendants()) do
        if d:IsA("ProximityPrompt") then
            patchPrompt(d)
            if type(fireproximityprompt) == "function" then pcall(function() fireproximityprompt(d) end) end
        end
    end
    pcall(function() packTool.Parent = plr.Backpack end)
end

local function parsePGP(pgp)
    if not pgp then return nil end
    if typeof(pgp) == "Vector3" then return pgp end
    if typeof(pgp) == "string" then
        local parts = pgp:split(",")
        if #parts == 3 then
            local x = tonumber(parts[1]:match("[%d%.%-]+"))
            local y = tonumber(parts[2]:match("[%d%.%-]+"))
            local z = tonumber(parts[3]:match("[%d%.%-]+"))
            if x and y and z then return Vector3.new(x, y, z) end
        end
    end
    return nil
end

local function getGardenBounds()
    local clientPlants = Workspace:FindFirstChild("ClientPlants")
    if not clientPlants then return nil end
    local positions = {}
    for _, p in pairs(clientPlants:GetChildren()) do
        if p:IsA("Model") then
            local pos = parsePGP(p:GetAttribute("PlantGroundPosition"))
            if not pos then
                local pp = p.PrimaryPart or p:FindFirstChildOfClass("BasePart")
                if pp and pp.Position.Magnitude > 1 then pos = pp.Position end
            end
            if pos then table.insert(positions, pos) end
        end
    end
    if #positions == 0 then
        local plot = getPlot()
        if plot then
            local ok, cf, sz = pcall(function() local c, s = plot:GetBoundingBox(); return c, s end)
            if ok and cf and sz and sz.X > 2 and sz.Z > 2 then
                return { center = cf.Position, groundY = cf.Position.Y, halfX = sz.X / 2 - 1, halfZ = sz.Z / 2 - 1 }
            end
        end
        return nil
    end
    local minX, maxX = math.huge, -math.huge
    local minZ, maxZ = math.huge, -math.huge
    local sumY, countY = 0, 0
    for _, pos in pairs(positions) do
        if pos.X < minX then minX = pos.X end; if pos.X > maxX then maxX = pos.X end
        if pos.Z < minZ then minZ = pos.Z end; if pos.Z > maxZ then maxZ = pos.Z end
        sumY = sumY + pos.Y; countY = countY + 1
    end
    local groundY = sumY / countY
    local centerX = (minX + maxX) / 2; local centerZ = (minZ + maxZ) / 2
    local halfX = math.max((maxX - minX) / 2 + 3, 5); local halfZ = math.max((maxZ - minZ) / 2 + 3, 5)
    return { center = Vector3.new(centerX, groundY + 3, centerZ), groundY = groundY, halfX = halfX, halfZ = halfZ }
end

local function getOccupiedPositions()
    local occupied = {}
    local clientPlants = Workspace:FindFirstChild("ClientPlants")
    if not clientPlants then return occupied end
    for _, p in pairs(clientPlants:GetChildren()) do
        if p:IsA("Model") then
            local pos = parsePGP(p:GetAttribute("PlantGroundPosition"))
            if not pos then local pp = p.PrimaryPart or p:FindFirstChildOfClass("BasePart"); if pp and pp.Position.Magnitude > 1 then pos = pp.Position end end
            if pos then table.insert(occupied, pos) end
        end
    end
    return occupied
end

local function isPositionFree(pos, occupied, minDist)
    for _, occ in pairs(occupied) do
        if math.abs(pos.X - occ.X) < minDist and math.abs(pos.Z - occ.Z) < minDist then return false end
    end
    return true
end

local function generatePlantSpots(bounds, count, minDist)
    local occupied = getOccupiedPositions()
    local spots = {}
    local maxSpots = math.min(count, 500)
    
    -- STRATEGY 1: Use grid-snapped positions based on existing plant spacing
    -- Find the actual grid spacing from existing plants
    local gridSize = 4 -- default 4 studs
    if #occupied >= 2 then
        -- Find minimum distance between existing plants to determine grid size
        local minFound = 999
        for i = 1, math.min(#occupied, 10) do
            for j = i + 1, math.min(#occupied, 10) do
                local d = (occupied[i] - occupied[j]).Magnitude
                if d > 1 and d < minFound then minFound = d end
            end
        end
        if minFound < 999 and minFound > 1 then gridSize = math.floor(minFound + 0.5) end
    end
    if gridSize < 2 then gridSize = 4 end
    
    -- Pre-build grid for O(1) collision check
    local grid = {}
    local function toCell(x, z)
        return math.floor(x / gridSize + 0.5) .. "," .. math.floor(z / gridSize + 0.5)
    end
    for _, pos in pairs(occupied) do
        grid[toCell(pos.X, pos.Z)] = true
    end
    
    -- STRATEGY 2: Generate grid-aligned positions (much higher success rate)
    local startX = bounds.center.X - bounds.halfX
    local endX = bounds.center.X + bounds.halfX
    local startZ = bounds.center.Z - bounds.halfZ
    local endZ = bounds.center.Z + bounds.halfZ
    
    -- Snap start to grid
    startX = math.floor(startX / gridSize) * gridSize
    startZ = math.floor(startZ / gridSize) * gridSize
    
    -- Walk the grid systematically
    local candidates = {}
    local x = startX
    while x <= endX do
        local z = startZ
        while z <= endZ do
            local key = toCell(x, z)
            if not grid[key] then
                table.insert(candidates, Vector3.new(x, bounds.groundY, z))
            end
            z = z + gridSize
        end
        x = x + gridSize
    end
    
    -- Shuffle candidates for variety
    for i = #candidates, 2, -1 do
        local j = math.random(1, i)
        candidates[i], candidates[j] = candidates[j], candidates[i]
    end
    
    -- Take up to maxSpots
    for i = 1, math.min(#candidates, maxSpots) do
        table.insert(spots, candidates[i])
    end
    
    return spots
end

local function getSeedsToPlant()
    local mode = Config.plantSeedMode; local result = {}
    if mode == "Seed in Inv" then
        if #Config.selectedSeeds == 0 then
            for _, n in pairs(getSeedNames()) do local t = getSeedTool(n); if t then table.insert(result, t) end end
        else
            for _, n in pairs(Config.selectedSeeds) do local t = getSeedTool(n); if t then table.insert(result, t) end end
        end
    elseif mode == "All Seed" then
        for _, i in pairs(getInv()) do if i:GetAttribute("Type") == "Seeds" then table.insert(result, i) end end
    elseif mode == "Select Seed" then
        for _, n in pairs(Config.selectedSeedsFull) do local t = getSeedTool(n); if t then table.insert(result, t) end end
    end
    return result
end

local autoPlantRunning = false
local function autoPlant()
    if autoPlantRunning then return end
    if not Config.autoPlant then return end
    waitSellDone()
    if not acquireToolMutex(3) then return end
    autoPlantRunning = true
    
    pcall(function()
        local hrp = getHRP()
        if not hrp then return end
        
        -- TP to garden center first
    local gardenCenter = calcGardenCenter()
    if gardenCenter then
        tpTo(gardenCenter + Vector3.new(0, 3, 0)); task.wait(0.3)
    end
    
    local bounds = getGardenBounds()
    if not bounds then
        showNotif("Auto Plant", "Can't find garden bounds!", 2)
        autoPlantRunning = false; releaseToolMutex(); return
    end
    
    local isMax = Config.plantAmount >= 51
    local target = isMax and 9999 or Config.plantAmount
    local iv = math.max(Config.plantInterval, 0.1)  -- Minimum 0.1s agar tidak lag
    
    -- Generate spots di luar loop (sekali saja)
    local spots = generatePlantSpots(bounds, target, 2.5)
    if #spots == 0 then
        showNotif("Auto Plant", "No free spots!", 2)
        return
    end
    
    local planted = 0
    unequipAll(); task.wait(0.1)
    
    -- Cache seed tool di luar inner loop
    local lastSeedName = nil
    local lastSeedTool = nil
    
    for _, plantPos in ipairs(spots) do
        if not Config.autoPlant or _sellLock then break end
        
        local seedsThisRound = getSeedsToPlant()
        if #seedsThisRound == 0 then
            showNotif("Auto Plant", "No seeds left!", 2); break
        end
        
        local st = seedsThisRound[1]
        if not st or not st.Parent then break end
        local seedName = st:GetAttribute("BaseName") or st.Name
        
        -- Hanya re-equip kalau seed berubah atau belum equipped
        local char = plr.Character; if not char then break end
        local hum = char:FindFirstChildOfClass("Humanoid")
        
        local needEquip = true
        local equippedTool = char:FindFirstChildOfClass("Tool")
        if equippedTool then
            local en = equippedTool:GetAttribute("BaseName") or equippedTool.Name
            if en == seedName then needEquip = false; st = equippedTool end
        end
        
        if needEquip then
            -- Unequip semua dulu
            if equippedTool then
                pcall(function() equippedTool.Parent = plr.Backpack end)
                task.wait(0.05)
            end
            
            -- Pastikan tool ada di backpack
            local bp = plr:FindFirstChild("Backpack")
            local toolInBp = nil
            if bp then
                for _, item in pairs(bp:GetChildren()) do
                    if (item:GetAttribute("BaseName") or item.Name) == seedName then
                        toolInBp = item; break
                    end
                end
            end
            
            if not toolInBp then
                -- Tool hilang (mungkin habis), refresh list
                seedsThisRound = getSeedsToPlant()
                if #seedsThisRound == 0 then break end
                st = seedsThisRound[1]
                seedName = st:GetAttribute("BaseName") or st.Name
                toolInBp = getSeedTool(seedName)
                if not toolInBp then break end
            end
            
            -- Equip via Humanoid (lebih reliable dari direct parent change)
            if hum then
                pcall(function() hum:EquipTool(toolInBp) end)
            else
                pcall(function() toolInBp.Parent = char end)
            end
            
            -- Tunggu lebih lama agar server sync
            task.wait(0.25)
            
            -- Verifikasi equipped
            st = char:FindFirstChildOfClass("Tool")
            if not st then
                -- Fallback: coba cara lama
                pcall(function() toolInBp.Parent = char end)
                task.wait(0.2)
                st = char:FindFirstChildOfClass("Tool")
            end
            
            if not st then
                showNotif("Auto Plant", "Failed to equip " .. seedName, 2)
                break
            end
            
            lastSeedName = seedName
            lastSeedTool = st
        end
        
        -- Dapatkan plantType
        local plantType = st:GetAttribute("PlantType")
        if type(plantType) ~= "string" or plantType == "" then
            local bn = tostring(st:GetAttribute("BaseName") or st.Name)
            plantType = bn:gsub(" Seed", ""):gsub("x%d+ ", ""):match("^%s*(.-)%s*$")
        end
        
        if PlantSeed then
            local ok, res = pcall(function()
                return PlantSeed:InvokeServer(plantType, plantPos)
            end)
            if ok and res == true then
                planted = planted + 1
            end
        end
        
        task.wait(iv)
    end
    
    unequipAll()
    if planted > 0 then showNotif("Auto Plant", "Planted " .. planted, 1.5) end
    end)
    
    autoPlantRunning = false
    releaseToolMutex()
end

local autoWaterRunning = false
local function simClick(pos)
    pcall(function()
        local sp = Workspace.CurrentCamera:WorldToScreenPoint(pos)
        local vim = game:GetService("VirtualInputManager")
        vim:SendMouseButtonEvent(sp.X, sp.Y, 0, true, game, 0)
        vim:SendMouseButtonEvent(sp.X, sp.Y, 0, false, game, 0)
    end)
end

local function getPlants()
    local plants = {}
    local folders = { Workspace:FindFirstChild("ClientPlants"), Workspace:FindFirstChild("Plants") }
    local plot = getPlot(); if plot then table.insert(folders, plot:FindFirstChild("Plants")) end
    for _, folder in pairs(folders) do
        if not folder then continue end
        for _, plant in pairs(folder:GetDescendants()) do
            if not plant:IsA("Model") then continue end
            local hp = findHarvestPrompt(plant)
            local pa = plant:FindFirstChild("PlantAnchor") or plant:FindFirstChild("HarvestBoundingPart") or plant.PrimaryPart
            if hp or pa then
                local pos; if pa then pos = pa.Position else local cf2 = plant:GetBoundingBox(); pos = cf2.Position end
                local ripe = plant:GetAttribute("FullyGrown") or plant:GetAttribute("HarvestablePlant")
                table.insert(plants, { name = getPlantDisplayName(plant), model = plant, position = pos, fullyGrown = ripe, harvestPrompt = hp })
            end
        end
    end
    return plants
end
local function getPlantNames(onlyRipe)
    local r, added = {}, {}
    for _, p in pairs(getPlants()) do
        -- Filter out Fruit child models (Fruit1, Fruit2, etc.)
        if p.name and not p.name:match("^Fruit%d*$") and (not onlyRipe or p.fullyGrown) and not added[p.name] then
            table.insert(r, p.name); added[p.name] = true
        end
    end
    return r
end

local function autoWater()
    if autoWaterRunning then return end
    if not Config.autoWater then return end
    waitSellDone()
    if not acquireToolMutex(3) then return end
    autoWaterRunning = true
    
    pcall(function()
        local hasCan, wc = hasWaterCan()
        if not hasCan then return end
        local hrp = getHRP(); if not hrp then return end
        local origCF = hrp.CFrame
        unequipAll(); equipTool(wc); task.wait(0.1)
    for _, plant in pairs(getPlants()) do
        if not Config.autoWater or _sellLock then break end
        local should = Config.waterMode == "All"
        if not should then for _, s in pairs(Config.selectedWaterPlants) do if s == plant.name then should = true; break end end end
        if should then
            tpTo(plant.position + Vector3.new(0, 3, 0)); task.wait(0.1)
            if UseGear then local bn = wc:GetAttribute("BaseName") or wc.Name; pcall(function() UseGear:FireServer(bn, plant.position) end); task.wait(0.1) end
            simClick(plant.position); pcall(function() wc:Activate() end); task.wait(0.35)
        end
    end
        unequipTool(wc)
        waitSellDone()
        tpCF(origCF)
    end)
    
    autoWaterRunning = false
    releaseToolMutex()
end

local autoSprinklerRunning = false
local function placeSprinklerAt(tool, pos)
    if not tool then return false end
    local hrp = getHRP(); if not hrp then return false end
    tpTo(pos + Vector3.new(0, 5, 0)); task.wait(0.12)
    if UseGear then
        local bn = tool:GetAttribute("BaseName") or tool.Name
        pcall(function() UseGear:FireServer(bn, pos) end); task.wait(0.1)
        pcall(function() UseGear:FireServer(tool, pos) end); task.wait(0.1)
    end
    equipTool(tool); task.wait(0.1)
    pcall(function() tool:Activate() end)
    pcall(function()
        local vim = game:GetService("VirtualInputManager")
        local sp = workspace.CurrentCamera:WorldToScreenPoint(pos)
        vim:SendMouseButtonEvent(sp.X, sp.Y, 0, true, game, 0)
        task.wait(0.05)
        vim:SendMouseButtonEvent(sp.X, sp.Y, 0, false, game, 0)
    end)
    task.wait(0.2); unequipTool(tool); return true
end
local function getSprinklerTool(name)
    for _, i in pairs(getInv()) do local bn = i:GetAttribute("BaseName") or i.Name; if bn == name then return i end end
end
local function getPlantableArea()
    local spots = {}; local plot = getPlot(); if not plot then return spots end
    local pa = plot:FindFirstChild("PlantableArea")
    if pa then for _, p in pairs(pa:GetDescendants()) do if p:IsA("BasePart") then table.insert(spots, p.Position + Vector3.new(0, 1, 0)) end end end
    if #spots == 0 then
        local cf, _ = plot:GetBoundingBox()
        for x = -3, 3 do for z = -3, 3 do table.insert(spots, cf.Position + Vector3.new(x * 5, 1, z * 5)) end end
    end
    return spots
end
local function autoPlaceSprinkler()
    if autoSprinklerRunning then return end
    if not Config.autoSprinkler then return end
    waitSellDone()
    if not acquireToolMutex(3) then return end
    autoSprinklerRunning = true
    
    pcall(function()
        local tool = getSprinklerTool(Config.sprinklerName)
        if not tool then showNotif("Sprinkler", "No " .. Config.sprinklerName .. " in inventory!", 2); return end
        local hrp = getHRP(); if not hrp then return end
        local origCF = hrp.CFrame
        local mode = Config.sprinklerPutMode
        if mode == "Player Position" then
            if not isInGarden() then showNotif("Sprinkler", "Go into your garden first.", 2); return end
            unequipAll(); placeSprinklerAt(tool, hrp.Position)
    elseif mode == "Random" then
        local spots = getPlantableArea()
        if #spots > 0 then unequipAll(); placeSprinklerAt(tool, spots[math.random(1, #spots)]) end
    elseif mode == "All Plants" then
        local plants2 = getPlants()
        if #plants2 > 0 then
            unequipAll()
            for _, plant in pairs(plants2) do
                if not Config.autoSprinkler then break end
                tool = getSprinklerTool(Config.sprinklerName)
                if not tool then showNotif("Sprinkler", "Out of " .. Config.sprinklerName, 2); break end
                -- Offset from plant so sprinkler lands NEXT TO the plant, not on top
                local offsetPos = plant.position + Vector3.new(math.random(-4, 4), 0, math.random(-4, 4))
                placeSprinklerAt(tool, offsetPos); task.wait(0.3)
            end
        end
    end
        tpCF(origCF)
    end)
    
    autoSprinklerRunning = false
    releaseToolMutex()
end

local function getCellId(plantModel)
    if not plantModel then return nil end
    local cid = plantModel:GetAttribute("CellId") or plantModel:GetAttribute("CellID") or plantModel:GetAttribute("PlotId") or plantModel:GetAttribute("Id") or plantModel:GetAttribute("Index")
    if cid then return cid end
    local idx = plantModel.Name:match("%d+$"); if idx then return tonumber(idx) end
    return nil
end
local function deletePlant(plantName)
    if not plantName or plantName == "" then return false end
    local targetPlant = nil
    for _, plant in pairs(getPlants()) do if plant.name == plantName then targetPlant = plant; break end end
    if not targetPlant then return false end
    local hrp = getHRP(); if not hrp then return false end
    waitSellDone()
    if not acquireToolMutex(3) then return false end
    local origCF = hrp.CFrame
    
    pcall(function()
        tpTo(targetPlant.position + Vector3.new(0, 5, 0)); task.wait(0.15)
    if RemovePlant then
        pcall(function() RemovePlant:FireServer(targetPlant.model) end); task.wait(0.1)
        local cellId = getCellId(targetPlant.model)
        if cellId then pcall(function() RemovePlant:FireServer(cellId) end) end
    end
    local shovel = getShovelTool()
    if shovel then
        unequipAll(); equipTool(shovel); task.wait(0.2)
        simClick(targetPlant.position); pcall(function() shovel:Activate() end); task.wait(0.3)
        unequipTool(shovel)
    end
        tpCF(origCF)
    end)
    
    releaseToolMutex()
    return true
end

local function doAutoDeletePlant()
    if not Config.autoDeletePlant then return end
    local plantName = Config.selectedDeletePlant
    if not plantName or plantName == "" then return end
    deletePlant(plantName)
end

local fireClick
fireClick = function(btn)
    if not btn then return end
    if type(firebutton) == "function" then pcall(function() firebutton(btn, "MouseButton1Click") end) end
    if type(firesignal) == "function" then pcall(function() firesignal(btn.MouseButton1Click) end) end
    pcall(function() btn.MouseButton1Click:Fire() end)
    pcall(function()
        local pos = btn.AbsolutePosition + btn.AbsoluteSize / 2
        local vim = game:GetService("VirtualInputManager")
        vim:SendMouseButtonEvent(pos.X, pos.Y, 0, true, game, 0)
        task.wait(0.05); vim:SendMouseButtonEvent(pos.X, pos.Y, 0, false, game, 0)
    end)
end
local function findConfirmButton(ps)
    if not ps then return nil end
    local frame = ps:FindFirstChild("Frame")
    if frame then local middleBit = frame:FindFirstChild("MiddleBit"); if middleBit then local confirm = middleBit:FindFirstChild("Confirm"); if confirm then return confirm end end end
    for _, d in pairs(ps:GetDescendants()) do if d.Name == "Confirm" and (d:IsA("ImageButton") or d:IsA("TextButton")) then return d end end
    return nil
end
local function trySkipLoading(ps)
    if not ps then return end
    local skipKeywords = { "skip", "continue", "next", "ok", "done", "ready", "close", "proceed" }
    for _, d in pairs(ps:GetDescendants()) do
        if d:IsA("ImageButton") or d:IsA("TextButton") then
            local name = d.Name:lower(); local txt = (d:IsA("TextButton") and d.Text or ""):lower()
            local isSkip = false
            for _, kw in pairs(skipKeywords) do if name:find(kw) or txt:find(kw) then isSkip = true; break end end
            if isSkip and name ~= "confirm" then fireClick(d); task.wait(0.15) end
        end
    end
end
local autoClaimRunning = false
local function doClaimViaUI()
    if hasPlot() then
        Config.autoClaimPlot = false; saveConfig()
        if _toggleRefs["autoClaimPlot"] then
            local tg = _toggleRefs["autoClaimPlot"]
            if tg and tg:FindFirstChild("Knob") then
                TweenService:Create(tg:FindFirstChild("Knob"), TweenInfo.new(0.2, Enum.EasingStyle.Quad), { Position = UDim2.new(0, 3, 0.5, -8) }):Play()
                TweenService:Create(tg, TweenInfo.new(0.2), { BackgroundColor3 = Color3.fromRGB(50, 55, 65) }):Play()
            end
        end
        showNotif("Plot", "Already have a plot!", 2); return
    end
    local ps = plr.PlayerGui:FindFirstChild("PlotSelector")
    if not ps then
        local t = tick(); repeat task.wait(0.3); ps = plr.PlayerGui:FindFirstChild("PlotSelector") until ps or tick() - t > 15
        if not ps then showNotif("Claim", "PlotSelector not found!", 2); return end
    end
    if not ps.Enabled then pcall(function() ps.Enabled = true end); task.wait(0.2) end
    local confirm = findConfirmButton(ps); local waitT = tick()
    while (not confirm or not confirm.Visible) and tick() - waitT < 20 do
        trySkipLoading(ps); task.wait(0.3); confirm = findConfirmButton(ps)
    end
    if not confirm then showNotif("Claim", "Confirm button not found!", 2); return end
    task.wait(0.1); fireClick(confirm); showNotif("Claim", "Clicked Confirm!", 1.5)
    local gotPlot = false; local waitT2 = tick()
    repeat task.wait(0.5); gotPlot = hasPlot() until gotPlot or tick() - waitT2 > 8
    if gotPlot then showNotif("Plot", "Plot claimed!", 2); Config.autoClaimPlot = false; saveConfig() end
end
local function runAutoClaim()
    if autoClaimRunning then return end
    if not Config.autoClaimPlot then return end
    autoClaimRunning = true
    task.spawn(function()
        local attempts = 0
        while Config.autoClaimPlot and not hasPlot() and attempts < 10 do
            attempts = attempts + 1; doClaimViaUI()
            if hasPlot() then break end; task.wait(2)
        end
        autoClaimRunning = false
    end)
end
plr.PlayerGui.ChildAdded:Connect(function(child)
    if child.Name == "PlotSelector" and Config.autoClaimPlot then task.wait(0.2); task.spawn(doClaimViaUI) end
end)

local infMoneyConn = nil
local function enableInfMoney()
    if infMoneyConn then infMoneyConn:Disconnect(); infMoneyConn = nil end
    local function hookLabel(lbl)
        if not lbl then return end; lbl.Text = "inf"
        infMoneyConn = lbl:GetPropertyChangedSignal("Text"):Connect(function() if Config.infMoney then lbl.Text = "inf" end end)
    end
    local gui = plr.PlayerGui:FindFirstChild("ShillingsCurrency")
    if gui then
        local ca = gui:FindFirstChild("CurrencyAmount", true)
        if ca then
            if ca:IsA("TextLabel") then hookLabel(ca); return end
            local lbl = ca:FindFirstChildOfClass("TextLabel"); if lbl then hookLabel(lbl); return end
        end
        for _, d in pairs(gui:GetDescendants()) do
            if d:IsA("TextLabel") then
                local t = d.Text or ""
                if t:match("^%d") or t:match("^[%d,]+") then hookLabel(d); return end
            end
        end
    end
    task.spawn(function() task.wait(2); if Config.infMoney then enableInfMoney() end end)
end
local function disableInfMoney()
    if infMoneyConn then infMoneyConn:Disconnect(); infMoneyConn = nil end
end

local _espConnections = {}
local _espBillboards = {}
local function clearESP()
    for _, v in pairs(_espBillboards) do pcall(function() v:Destroy() end) end
    _espBillboards = {}
    for _, c in pairs(_espConnections) do pcall(function() c:Disconnect() end) end
    _espConnections = {}
end

local function createFruitBillboard(fruitOrPlant, plantModel, parentPart)
    if not parentPart then return end
    local bb = Instance.new("BillboardGui"); bb.Name = "ESP_BB"
    bb.Size = UDim2.new(0, 160, 0, 90)
    bb.StudsOffset = Vector3.new(0, 3, 0)
    bb.AlwaysOnTop = true; bb.Adornee = parentPart; bb.Parent = Workspace
    local sel = Instance.new("SelectionBox")
    sel.SurfaceTransparency = 0.8; sel.Color3 = Color3.fromRGB(50, 130, 255)
    sel.SurfaceColor3 = Color3.fromRGB(50, 130, 255); sel.LineThickness = 0.05
    sel.Adornee = parentPart; sel.Parent = Workspace
    table.insert(_espBillboards, bb)
    table.insert(_espBillboards, sel)
    local plantType = plantModel:GetAttribute("PlantType") or "Unknown"
    local weight = fruitOrPlant:GetAttribute("FruitWeight") or plantModel:GetAttribute("FruitWeight") or 0
    local weightStr = string.format("%.3f Kg", weight)
    local ripenessStage = fruitOrPlant:GetAttribute("RipenessStage") or plantModel:GetAttribute("RipenessStage") or "?"
    local fullyGrown = fruitOrPlant:GetAttribute("FullyGrown")
    local growthPct = getGrowthPercent(fruitOrPlant) or getGrowthPercent(plantModel)
    local growStr = fullyGrown and "100%" or (growthPct .. "%")
    local estVal = estimateFruitValue(fruitOrPlant, plantType)
    local mutations = getMutationsString(fruitOrPlant)
    local yOff = 2
    local function addLine(text, color, size)
        local lbl = Instance.new("TextLabel", bb)
        lbl.Size = UDim2.new(1, 0, 0, size or 12)
        lbl.Position = UDim2.new(0, 0, 0, yOff)
        lbl.BackgroundTransparency = 1
        lbl.Text = text; lbl.TextColor3 = color
        lbl.Font = Enum.Font.GothamBold; lbl.TextSize = size or 10
        lbl.TextStrokeTransparency = 0.5; lbl.TextStrokeColor3 = Color3.fromRGB(0,0,0)
        yOff = yOff + (size or 12) + 1
    end
    local fr = Instance.new("Frame", bb); fr.Size = UDim2.new(1,0,0,14); fr.Position = UDim2.new(0,0,0,yOff); fr.BackgroundTransparency = 1
    local function addSegment(parent, txt, col, offset, w)
        local l = Instance.new("TextLabel", parent); l.Size = UDim2.new(0, w, 1, 0); l.Position = UDim2.new(0, offset, 0, 0)
        l.BackgroundTransparency = 1; l.Text = txt; l.TextColor3 = col
        l.Font = Enum.Font.GothamBold; l.TextSize = 9; l.TextXAlignment = Enum.TextXAlignment.Center
        l.TextStrokeTransparency = 0.5; l.TextStrokeColor3 = Color3.fromRGB(0,0,0)
    end
    addSegment(fr, plantType, Color3.fromRGB(255, 80, 80), 0, 38)
    addSegment(fr, weightStr, Color3.fromRGB(80, 220, 80), 39, 40)
    addSegment(fr, ripenessStage, Color3.fromRGB(80, 130, 255), 80, 40)
    addSegment(fr, growStr, Color3.fromRGB(255, 220, 50), 121, 34)
    table.insert(_espBillboards, fr)
    yOff = yOff + 15
    if #mutations > 0 then
        local mutParts = {}
        for _, m in pairs(mutations) do table.insert(mutParts, m) end
        table.insert(mutParts, "None")
        local mfr = Instance.new("Frame", bb); mfr.Size = UDim2.new(1,0,0,12); mfr.Position = UDim2.new(0,0,0,yOff); mfr.BackgroundTransparency = 1
        local segW = math.floor(155 / #mutParts)
        for i, m in ipairs(mutParts) do
            local col = m == "None" and Color3.fromRGB(130,130,130) or Color3.fromRGB(255, 165, 0)
            addSegment(mfr, m, col, (i-1)*segW, segW)
        end
        table.insert(_espBillboards, mfr)
        yOff = yOff + 13
    else
        addLine("None", Color3.fromRGB(130,130,130), 10)
    end
    addLine("$" .. tostring(estVal), Color3.fromRGB(80, 220, 80), 10)
    bb.Size = UDim2.new(0, 160, 0, yOff + 2)
end

local function runESP()
    clearESP()
    if not Config.espEnabled then return end
    local mode = Config.espMode
    local clientPlants = Workspace:FindFirstChild("ClientPlants")
    if not clientPlants then return end
    if mode == "Fruit ESP" or mode == "Mutations ESP" then
        for _, plantModel in pairs(clientPlants:GetChildren()) do
            if not plantModel:IsA("Model") then continue end
            local isHarvestable = plantModel:GetAttribute("HarvestablePlant")
            if isHarvestable then
                if not plantModel:GetAttribute("FullyGrown") then continue end
                if mode == "Mutations ESP" then
                    local mut = plantModel:GetAttribute("Mutation") or ""
                    local selMut = Config.espSelectedMutation
                    if selMut ~= "" and not mut:find(selMut, 1, true) then continue end
                end
                local pp = plantModel:FindFirstChild("HarvestBoundingPart") or plantModel.PrimaryPart or plantModel:FindFirstChildOfClass("BasePart")
                if pp then createFruitBillboard(plantModel, plantModel, pp) end
            else
                for _, fruit in pairs(plantModel:GetChildren()) do
                    if not fruit:IsA("Model") or not fruit.Name:match("^Fruit") then continue end
                    if not fruit:GetAttribute("FullyGrown") then continue end
                    if mode == "Mutations ESP" then
                        local mut = fruit:GetAttribute("Mutation") or ""
                        local selMut = Config.espSelectedMutation
                        if selMut ~= "" and not mut:find(selMut, 1, true) then continue end
                    end
                    local pp = fruit:FindFirstChild("FruitAnchor") or fruit.PrimaryPart or fruit:FindFirstChildOfClass("BasePart")
                    if pp then createFruitBillboard(fruit, plantModel, pp) end
                end
            end
        end
    elseif mode == "Player ESP" then
        for _, otherPlr in pairs(Players:GetPlayers()) do
            if otherPlr == plr then continue end
            local char = otherPlr.Character; if not char then continue end
            local hrp = char:FindFirstChild("HumanoidRootPart"); if not hrp then continue end
            local bb = Instance.new("BillboardGui"); bb.Name = "ESP_BB"
            bb.Size = UDim2.new(0, 120, 0, 28); bb.StudsOffset = Vector3.new(0, 3, 0)
            bb.AlwaysOnTop = true; bb.Adornee = hrp; bb.Parent = Workspace
            local lbl = Instance.new("TextLabel", bb); lbl.Size = UDim2.new(1,0,1,0)
            lbl.BackgroundTransparency = 1; lbl.Text = otherPlr.DisplayName
            lbl.TextColor3 = Color3.fromRGB(255, 255, 100); lbl.Font = Enum.Font.GothamBold; lbl.TextSize = 12
            lbl.TextStrokeTransparency = 0.5
            table.insert(_espBillboards, bb)
        end
    elseif mode == "NPC ESP" then
        local shops = Workspace:FindFirstChild("MapPhysical") and Workspace.MapPhysical:FindFirstChild("Shops")
        if shops then
            local npcNames = { "SeedNPC", "GearNPC", "Steve" }
            for _, shopFolder in pairs(shops:GetChildren()) do
                for _, npcName in pairs(npcNames) do
                    local npc = shopFolder:FindFirstChild(npcName)
                    if npc then
                        local hrp = npc:FindFirstChild("HumanoidRootPart") or npc.PrimaryPart
                        if hrp then
                            local bb = Instance.new("BillboardGui"); bb.Name = "ESP_BB"
                            bb.Size = UDim2.new(0, 130, 0, 28); bb.StudsOffset = Vector3.new(0, 3, 0)
                            bb.AlwaysOnTop = true; bb.Adornee = hrp; bb.Parent = Workspace
                            local lbl = Instance.new("TextLabel", bb); lbl.Size = UDim2.new(1,0,1,0)
                            lbl.BackgroundTransparency = 1
                            lbl.Text = npcName .. " [" .. shopFolder.Name .. "]"
                            lbl.TextColor3 = Color3.fromRGB(100, 255, 220); lbl.Font = Enum.Font.GothamBold; lbl.TextSize = 11
                            lbl.TextStrokeTransparency = 0.5
                            table.insert(_espBillboards, bb)
                        end
                    end
                end
            end
        end
    end
end

local _invEspConns = {}
local function clearInvESP()
    for _, c in pairs(_invEspConns) do pcall(function() c:Disconnect() end) end
    _invEspConns = {}
    local bpGui = plr.PlayerGui:FindFirstChild("BackpackGui")
    if bpGui then
        for _, lbl in pairs(bpGui:GetDescendants()) do
            if lbl.Name == "C_FruitValueLabel" then pcall(function() lbl:Destroy() end) end
        end
    end
end

-- ==================== FIXED: updateInvESP ====================
-- Backpack tools have FruitValue attribute set directly by server (confirmed: FruitValue=72 on Corn)
-- tool.Name matches ToolName label exactly (e.g., "Corn (0.23 KG)")
local function updateInvESP()
    if not Config.espAllInventory then return end
    local bpGui = plr.PlayerGui:FindFirstChild("BackpackGui")
    if not bpGui then return end

    -- Clean old labels
    for _, lbl in pairs(bpGui:GetDescendants()) do
        if lbl.Name == "C_FruitValueLabel" then pcall(function() lbl:Destroy() end) end
    end

    -- Build map: tool.Name -> FruitValue (tool.Name == ToolName label, e.g. "Corn (0.23 KG)")
    local valueMap = {}
    for _, item in pairs(getInv()) do
        if item:GetAttribute("Type") ~= "Plants" then continue end
        -- Primary: FruitValue attribute is set by server on backpack tools
        local fv = item:GetAttribute("FruitValue")
        local baseCalc = 0
        if fv and type(fv) == "number" and fv > 0 then
            baseCalc = fv
        else
            -- Fallback: calculate from HiddenNumber (= FruitScale) and PlantDataDefs
            local plantType = item:GetAttribute("BaseName") or item:GetAttribute("HarvestedFrom") or ""
            local hiddenNumber = item:GetAttribute("HiddenNumber") or 1
            local ripMult = item:GetAttribute("RipenessMultiplier") or 1
            baseCalc = calcFruitValue(plantType, hiddenNumber, ripMult)
        end
        if baseCalc > 0 then
            valueMap[item.Name] = math.floor(baseCalc * getSellMultiplier())
        end
    end

    if next(valueMap) == nil then return end

    local backpack = bpGui:FindFirstChild("Backpack")
    if not backpack then return end

    -- Collect all slots from confirmed structure:
    -- Hotbar: Backpack > Hotbar > [TextButton "1".."10"]
    -- Inventory: Backpack > Inventory > ScrollingFrame > UIGridFrame > [PoolSlot_N TextButton]
    local allSlots = {}
    local hotbar = backpack:FindFirstChild("Hotbar")
    if hotbar then
        for _, s in ipairs(hotbar:GetChildren()) do
            if s:IsA("TextButton") then table.insert(allSlots, s) end
        end
    end
    local inv = backpack:FindFirstChild("Inventory")
    if inv then
        local sf = inv:FindFirstChild("ScrollingFrame")
        if sf then
            local grid = sf:FindFirstChild("UIGridFrame")
            local container = grid or sf
            for _, s in ipairs(container:GetChildren()) do
                if s:IsA("TextButton") then table.insert(allSlots, s) end
            end
        end
    end

    for _, slot in ipairs(allSlots) do
        -- ToolName is a direct child TextLabel of the slot (confirmed from scan)
        local tn = slot:FindFirstChild("ToolName")
        if not tn or tn.Text == "" then continue end
        local fv = valueMap[tn.Text]
        if not fv then continue end

        local lbl = Instance.new("TextLabel", slot)
        lbl.Name = "C_FruitValueLabel"
        lbl.Size = UDim2.new(1, 0, 0, 13)
        lbl.Position = UDim2.new(0, 0, 1, -13)
        lbl.BackgroundColor3 = Color3.fromRGB(0, 140, 0)
        lbl.BackgroundTransparency = 0.25
        lbl.Text = "$" .. tostring(fv)
        lbl.TextColor3 = Color3.fromRGB(255, 255, 255)
        lbl.Font = Enum.Font.GothamBold
        lbl.TextSize = 9
        lbl.ZIndex = 200
        Instance.new("UICorner", lbl).CornerRadius = UDim.new(0, 3)
    end
end

local _questUpdateConn = nil
local _questRawCache = {}
local function hookUpdateQuests()
    if _questUpdateConn then return end
    if not UpdateQuests then return end
    _questUpdateConn = UpdateQuests.OnClientEvent:Connect(function()
        task.defer(function()
            task.wait(0.3)
            local gui = plr.PlayerGui:FindFirstChild("Quests"); if not gui then return end
            local bg = gui:FindFirstChild("BG"); if not bg then return end
            local sf = bg:FindFirstChild("ScrollingFrame"); if not sf then return end
            local names = {}
            for _, slot in pairs(sf:GetChildren()) do
                local qn = slot:FindFirstChild("QuestName")
                if qn then
                    local nm = qn:IsA("StringValue") and qn.Value or (qn:IsA("TextLabel") and qn.Text or "")
                    nm = nm:gsub("^%s+", ""):gsub("%s+$", "")
                    if nm ~= "" and nm ~= "Quest Name" and nm ~= "..." then table.insert(names, nm) end
                end
            end
            if #names > 0 then _questRawCache = names end
        end)
    end)
end
local function fastScanQuests()
    local names = {}
    local gui = plr.PlayerGui:FindFirstChild("Quests"); if not gui then return _questRawCache end
    local bg = gui:FindFirstChild("BG"); if not bg then return _questRawCache end
    local sf = bg:FindFirstChild("ScrollingFrame"); if not sf then return _questRawCache end
    for _, slot in pairs(sf:GetChildren()) do
        local qn = slot:FindFirstChild("QuestName") or slot:FindFirstChild("Quest Name") or slot:FindFirstChild("Title")
        if qn then
            local nm = qn:IsA("StringValue") and qn.Value or (qn:IsA("TextLabel") and qn.Text or "")
            nm = nm:gsub("^%s+", ""):gsub("%s+$", "")
            if nm ~= "" and nm ~= "Quest Name" and nm ~= "..." and not nm:find("<font") and #nm > 3 then
                local added = false; for _, e in pairs(names) do if e == nm then added = true; break end end
                if not added then table.insert(names, nm) end
            end
        end
    end
    if #names > 0 then _questRawCache = names end
    return #names > 0 and names or _questRawCache
end

local function claimQuestRewards()
    local gui = plr.PlayerGui:FindFirstChild("Quests")
    if gui then
        local wasEnabled = gui.Enabled; gui.Enabled = true; task.wait(0.15)
        for _, d in pairs(gui:GetDescendants()) do
            if d:IsA("TextButton") or d:IsA("ImageButton") then
                local name = d.Name:lower(); local txt = (d:IsA("TextButton") and d.Text or ""):lower()
                if name:find("claim") or name:find("collect") or name:find("reward") or txt:find("claim") or txt:find("collect") then
                    fireClick(d); task.wait(0.1)
                end
            end
        end
        gui.Enabled = wasEnabled; task.wait(0.2)
    end
    if ClaimRewardEv then pcall(function() ClaimRewardEv:FireServer() end) end
    if ClaimQuestEv then pcall(function() ClaimQuestEv:FireServer() end) end
end

local function executeQuest(questName)
    if not questName or questName == "" then return end
    if ClaimQuestEv then pcall(function() ClaimQuestEv:FireServer(questName) end) end
    if ClaimRewardEv then pcall(function() ClaimRewardEv:FireServer(questName) end) end
end

-- ==================== BOTANIST FEATURES ====================
local appraiseRunning = false
local function doAutoAppraise()
    if appraiseRunning then return end
    if not Config.autoAppraise then return end
    if not BotanistRequest then return end
    waitSellDone()
    if not acquireToolMutex(3) then return end
    appraiseRunning = true
    
    pcall(function()
        local hrp = getHRP(); if not hrp then return end
        local bp = plr:FindFirstChild("Backpack"); if not bp then return end
        
        local targetItem = nil
        for _, item in pairs(bp:GetChildren()) do
            if not Config.autoAppraise or _sellLock then break end
            if item:GetAttribute("Type") ~= "Plants" then continue end
            if not item:GetAttribute("FullyGrown") then continue end
            
            local muts = Config.appraiseMutations
            local currentMut = item:GetAttribute("Mutation") or ""
            local variant = item:GetAttribute("Variant") or ""
            local ripeness = item:GetAttribute("RipenessStage") or ""
            
            local isTargetMut = false
            if #muts > 0 then
                for _, m in ipairs(muts) do
                    if currentMut:find(m, 1, true) or variant == m or ripeness == m then isTargetMut = true; break end
                end
            else
                if currentMut ~= "" then isTargetMut = true end
            end
            
            if not isTargetMut then
                targetItem = item
                break
            end
        end
        
        if targetItem then
            if tpToNPCReady("Botanist", "Botanist", 3, 5) then
                equipTool(targetItem)
                task.wait(0.25)
                pcall(function() BotanistRequest:InvokeServer() end)
                task.wait(0.2)
                unequipTool(targetItem)
            end
        end
    end)
    appraiseRunning = false
    releaseToolMutex()
end

local maraRunning = false
local function doAutoMaraQuest()
    if maraRunning then return end
    if not Config.autoRefreshMara and not Config.autoCompleteMara then return end
    if not BotanistQuestRequest then return end
    if _sellLock then return end
    waitSellDone()
    if not acquireToolMutex(4) then return end
    maraRunning = true
    
    pcall(function()
        local hrp = getHRP(); if not hrp then return end
        if tpToNPCReady("Botanist", "Botanist", 3, 5) then
            if Config.autoRefreshMara or Config.autoCompleteMara then
                local res = BotanistQuestRequest:InvokeServer("GetQuest")
                if res and type(res) == "table" and res.Status ~= "error" and res.Mutation then
                    local mut = res.Mutation
                    if mut == "Soaked" then _currentMaraQuestMutations = {"Soaked", "Flooded"}
                    elseif mut == "Chilled" then _currentMaraQuestMutations = {"Chilled", "Snowy"}
                    else _currentMaraQuestMutations = {mut} end
                end
                task.wait(0.2)
            end
            if Config.autoCompleteMara then
                pcall(function() BotanistQuestRequest:InvokeServer("TurnInAll") end)
                task.wait(0.2)
            end
        end
    end)
    maraRunning = false
    releaseToolMutex()
end

-- ==================== AUTO QUEST (DOES ACTUAL QUEST WORK) ====================
local autoQuestRunning = false

local function parseQuestText(text)
    if not text then return nil end
    text = text:gsub("^%s+", ""):gsub("%s+$", "")
    local action, amt, plant = text:match("^(Harvest)%s+(%d+)%s+(.+)$")
    if action then return { action = "Harvest", amount = tonumber(amt), plant = plant:gsub("s$", ""):gsub("ies$", "y") } end
    action, amt, plant = text:match("^(Plant)%s+(%d+)%s+(.-)%s*[Ss]eed[s]?$")
    if action then return { action = "Plant", amount = tonumber(amt), plant = plant } end
    action, amt, plant = text:match("^(Plant)%s+(%d+)%s+(.+)$")
    if action then return { action = "Plant", amount = tonumber(amt), plant = plant:gsub("s$", ""):gsub("ies$", "y") } end
    return nil
end

local function autoQuest()
    if autoQuestRunning then return end
    if not Config.autoQuest then return end
    autoQuestRunning = true

    -- 1. Scan quest UI for quest text
    local questGui = plr.PlayerGui:FindFirstChild("Quests")
    if not questGui then autoQuestRunning = false; return end
    local quests = {}
    for _, d in pairs(questGui:GetDescendants()) do
        if (d:IsA("TextLabel") or d:IsA("TextButton")) then
            local txt = d.Text or ""
            if txt:match("^Harvest%s+%d+") or txt:match("^Plant%s+%d+") then
                local parsed = parseQuestText(txt)
                if parsed then
                    -- Check progress from sibling
                    local parentFrame = d.Parent
                    if parentFrame then
                        for _, sib in pairs(parentFrame:GetChildren()) do
                            if sib ~= d and (sib:IsA("TextLabel") or sib:IsA("TextButton")) then
                                local cur, mx = (sib.Text or ""):match("(%d+)%s*/%s*(%d+)")
                                if cur and mx then
                                    parsed.progress = tonumber(cur) or 0
                                    parsed.goal = tonumber(mx) or parsed.amount
                                    break
                                end
                            end
                        end
                    end
                    if not parsed.progress then parsed.progress = 0; parsed.goal = parsed.amount end
                    table.insert(quests, parsed)
                end
            end
        end
    end

    if #quests == 0 then autoQuestRunning = false; return end

    -- 2. Process each quest
    for _, q in ipairs(quests) do
        if not Config.autoQuest then break end
        local remaining = q.goal - q.progress
        if remaining <= 0 then continue end

        if q.action == "Harvest" then
            -- Find fully-grown plants of this type and harvest them
            local clientPlants = Workspace:FindFirstChild("ClientPlants")
            if clientPlants then
                local batch = {}
                for _, plant in pairs(clientPlants:GetChildren()) do
                    if not plant:IsA("Model") then continue end
                    if plant:GetAttribute("OwnerUserId") ~= plr.UserId then continue end
                    local pt = plant:GetAttribute("PlantType") or ""
                    if pt:lower() ~= q.plant:lower() and not pt:lower():find(q.plant:lower()) then continue end
                    if not plant:GetAttribute("FullyGrown") then continue end
                    if plant:GetAttribute("Favorited") then continue end
                    local uuid = plant:GetAttribute("Uuid")
                    if not uuid then continue end

                    if plant:GetAttribute("HarvestablePlant") then
                        table.insert(batch, { Uuid = uuid })
                    else
                        for _, fruit in pairs(plant:GetChildren()) do
                            if fruit:IsA("Model") and fruit:GetAttribute("FullyGrown") then
                                local gai = fruit:GetAttribute("GrowthAnchorIndex")
                                if gai then table.insert(batch, { Uuid = uuid, GrowthAnchorIndex = gai }) end
                            end
                        end
                    end
                    if #batch >= remaining then break end
                end

                if #batch > 0 and HarvestFruit then
                    -- Fire in batches of 10
                    for i = 1, #batch, 10 do
                        local sub = {}
                        for j = i, math.min(i + 9, #batch) do table.insert(sub, batch[j]) end
                        pcall(function() HarvestFruit:FireServer(sub) end)
                        task.wait(0.15)
                    end
                    showNotif("Auto Quest", "Harvested " .. math.min(#batch, remaining) .. " " .. q.plant, 2)
                end
            end

        elseif q.action == "Plant" then
            -- Check if we have seeds for this plant
            local seedName = q.plant .. " Seed"
            local hasSeed = false
            for _, item in pairs(getInv()) do
                local bn = item:GetAttribute("BaseName") or item.Name
                if bn == seedName then hasSeed = true; break end
            end
            -- If missing, try to buy
            if not hasSeed and PurchaseShopItem then
                showNotif("Auto Quest", "Buying " .. seedName .. "...", 2)
                doBuySeedBulk({seedName}, remaining, true)
                task.wait(1)
            end
            -- Trigger autoPlant for this seed type
            showNotif("Auto Quest", "Planting " .. q.plant .. " for quest", 2)
        end
    end

    -- 3. Also claim any claimable rewards
    claimQuestRewards()

    autoQuestRunning = false
end

local function applyWS(v) local c = plr.Character; if c then local h = c:FindFirstChildOfClass("Humanoid"); if h then h.WalkSpeed = v end end end
local function applyJP(v) local c = plr.Character; if c then local h = c:FindFirstChildOfClass("Humanoid"); if h then h.JumpPower = v end end end

plr.CharacterAdded:Connect(function()
    task.wait(1); applyWS(Config.walkSpeed); applyJP(Config.jumpPower)
    if Config.autoClaimPlot and not hasPlot() then runAutoClaim() end
    _toolMutex = false; _sellLock = false
    autoPlantRunning = false; autoWaterRunning = false
    autoCollectRunning = false; autoSellRunning = false; autoSprinklerRunning = false
    _patchedPrompts = {}
end)

local flyConn = nil
local function startFly()
    local c = plr.Character; if not c then return end
    local hrp = c:FindFirstChild("HumanoidRootPart"); if not hrp then return end
    local hum = c:FindFirstChildOfClass("Humanoid"); if not hum then return end
    hum.PlatformStand = true
    local bv = hrp:FindFirstChild("C_BV") or Instance.new("BodyVelocity", hrp)
    bv.Name = "C_BV"; bv.Velocity = Vector3.zero; bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
    local bg = hrp:FindFirstChild("C_BG") or Instance.new("BodyGyro", hrp)
    bg.Name = "C_BG"; bg.MaxTorque = Vector3.new(1e9, 1e9, 1e9); bg.CFrame = hrp.CFrame; bg.D = 100
    flyConn = RunService.Heartbeat:Connect(function()
        if not Config.fly then
            pcall(function() bv:Destroy(); bg:Destroy() end)
            hum.PlatformStand = false; flyConn:Disconnect(); flyConn = nil; return
        end
        local cam = Workspace.CurrentCamera; local dir = Vector3.zero
        if UIS:IsKeyDown(Enum.KeyCode.W) then dir = dir + cam.CFrame.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.S) then dir = dir - cam.CFrame.LookVector end
        if UIS:IsKeyDown(Enum.KeyCode.A) then dir = dir - cam.CFrame.RightVector end
        if UIS:IsKeyDown(Enum.KeyCode.D) then dir = dir + cam.CFrame.RightVector end
        if UIS:IsKeyDown(Enum.KeyCode.Space) then dir = dir + Vector3.new(0, 1, 0) end
        if UIS:IsKeyDown(Enum.KeyCode.LeftControl) then dir = dir - Vector3.new(0, 1, 0) end
        if dir.Magnitude > 0 then dir = dir.Unit end
        bv.Velocity = dir * Config.flySpeed; bg.CFrame = cam.CFrame
    end)
end
local function stopFly()
    if flyConn then flyConn:Disconnect(); flyConn = nil end
    local c = plr.Character; if not c then return end
    local hrp = c:FindFirstChild("HumanoidRootPart")
    if hrp then local b = hrp:FindFirstChild("C_BV"); if b then b:Destroy() end; local g = hrp:FindFirstChild("C_BG"); if g then g:Destroy() end end
    local h = c:FindFirstChildOfClass("Humanoid"); if h then h.PlatformStand = false end
end

local function applyFPS(l)
    if l == "Off" then return end
    pcall(function()
        local L = game:GetService("Lighting"); L.GlobalShadows = false
        for _, o in pairs(Workspace:GetDescendants()) do
            if o:IsA("BasePart") then o.CastShadow = false; if l == "High" then o.Material = Enum.Material.SmoothPlastic end
            elseif o:IsA("ParticleEmitter") or o:IsA("Trail") then o.Enabled = false end
        end
        if l == "High" then for _, o in pairs(L:GetChildren()) do if o:IsA("PostEffect") then o.Enabled = false end end end
    end)
end

local function redeemCodes()
    local codes = { "THANKYOU", "DAWNFRUIT", "358", "DAWN", "RELEASE" }
    if RedeemCode then
        for _, code in pairs(codes) do pcall(function() RedeemCode:InvokeServer(code) end); task.wait(1.2) end
        showNotif("Codes", "Submitted all codes!", 2); return
    end
    showNotif("Codes", "Open code box in-game first!", 2)
end

local _configNameInput = ""
local function getSavedConfigNames()
    local names = {}
    if type(Config.savedConfigs) == "table" then
        for _, c in pairs(Config.savedConfigs) do if type(c) == "table" and c.name then table.insert(names, c.name) end end
    end
    return names
end
local function createNamedConfig(name)
    if not name or name == "" then showNotif("Config", "Enter a config name first!", 2); return end
    for i, c in pairs(Config.savedConfigs) do if c.name == name then table.remove(Config.savedConfigs, i); break end end
    local snapshot = {}
    for k, v in pairs(Config) do
        if k ~= "savedConfigs" then
            if type(v) == "table" then local copy = {}; for kk, vv in pairs(v) do copy[kk] = vv end; snapshot[k] = copy
            else snapshot[k] = v end
        end
    end
    table.insert(Config.savedConfigs, { name = name, data = snapshot })
    Config.selectedConfigName = name; saveConfigForce(); showNotif("Config", "Saved: " .. name, 2)
end
local function restartLoopsFromConfig()
    stopLoop("plant"); stopLoop("sell"); stopLoop("water"); stopLoop("sprinkler")
    stopLoop("collect"); stopLoop("tpgarden"); stopLoop("buyseed"); stopLoop("buygear")
    stopLoop("questexec"); stopLoop("questclaim"); stopLoop("autoFav"); stopLoop("autoPack")
    stopLoop("autoDelPlant"); stopLoop("autoAppraise"); stopLoop("autoMara")
    task.wait(0.1)
    applyWS(Config.walkSpeed); applyJP(Config.jumpPower)
    if Config.fly then startFly() else stopFly() end
    if Config.infMoney then enableInfMoney() else disableInfMoney() end
    if Config.autoPlant then startLoop("plant", Config.plantInterval + 0.5, autoPlant) end
    if Config.autoCollect then startLoop("collect", 2, autoCollect) end
    if Config.autoSell then startLoop("sell", Config.sellInterval, doSell) end
    if Config.autoWater then startLoop("water", Config.waterInterval, autoWater) end
    if Config.autoSprinkler then startLoop("sprinkler", Config.sprinklerInterval, autoPlaceSprinkler) end
    if Config.autoTPGarden then startLoop("tpgarden", Config.tpGardenInterval, doTPGarden) end
    if Config.autoBuySeed then startLoop("buyseed", Config.buySeedInterval, function() if #Config.selectedBuySeeds > 0 then doBuySeedBulk(Config.selectedBuySeeds, Config.buySeedAmount, true) end end) end
    if Config.autoBuyGear then startLoop("buygear", Config.buyGearInterval, function() if #Config.selectedGear > 0 then doBuyGearBulk(Config.selectedGear, Config.buyGearAmount) end end) end
    if Config.autoQuest then startLoop("questexec", 10, function() if Config.autoQuest then autoQuest() end end) end
    if Config.autoClaimQuestReward then startLoop("questclaim", 60, function() if Config.autoClaimQuestReward then claimQuestRewards() end end) end
    if Config.autoFavorite then startLoop("autoFav", 3, doAutoFavorite) end
    if Config.autoOpenPack then startLoop("autoPack", Config.packOpenInterval + 0.5, doAutoOpenPack) end
    if Config.autoDeletePlant then startLoop("autoDelPlant", Config.deleteInterval, doAutoDeletePlant) end
    if Config.autoAppraise then startLoop("autoAppraise", Config.appraiseInterval, doAutoAppraise) end
    if Config.autoMaraQuest then startLoop("autoMara", Config.maraQuestInterval, doAutoMaraQuest) end
    if Config.espEnabled then runESP() else clearESP() end
    if Config.espAllInventory then updateInvESP() else clearInvESP() end
    for key, tgRef in pairs(_toggleRefs) do
        if tgRef and tgRef.Parent then
            local val = Config[key]
            if val then
                pcall(function() TweenService:Create(tgRef:FindFirstChild("Knob"), TweenInfo.new(0.2), { Position = UDim2.new(1, -19, 0.5, -8) }):Play() end)
                TweenService:Create(tgRef, TweenInfo.new(0.2), { BackgroundColor3 = Color3.fromRGB(45, 175, 85) }):Play()
            else
                pcall(function() TweenService:Create(tgRef:FindFirstChild("Knob"), TweenInfo.new(0.2), { Position = UDim2.new(0, 3, 0.5, -8) }):Play() end)
                TweenService:Create(tgRef, TweenInfo.new(0.2), { BackgroundColor3 = Color3.fromRGB(50, 55, 65) }):Play()
            end
        end
    end
end
local function loadNamedConfig(name)
    if not name or name == "" then showNotif("Config", "Select a config first!", 2); return end
    for _, c in pairs(Config.savedConfigs) do
        if c.name == name and type(c.data) == "table" then
            for k, v in pairs(c.data) do if Config[k] ~= nil then Config[k] = v end end
            for _, k in ipairs({ "selectedSeeds", "selectedSeedsFull", "selectedBuySeeds", "selectedWaterPlants", "selectedCollectPlants", "filterMutations", "selectedQuests", "selectedGear" }) do
                if type(Config[k]) ~= "table" then Config[k] = {} end
            end
            saveConfigForce(); showNotif("Config", "Loaded: " .. name, 2); task.spawn(restartLoopsFromConfig); return
        end
    end
    showNotif("Config", "Config not found: " .. name, 2)
end
local function deleteNamedConfig(name)
    if not name or name == "" then showNotif("Config", "Select a config first!", 2); return end
    for i, c in pairs(Config.savedConfigs) do
        if c.name == name then table.remove(Config.savedConfigs, i); Config.selectedConfigName = ""; saveConfigForce(); showNotif("Config", "Deleted: " .. name, 2); return end
    end
    showNotif("Config", "Config not found: " .. name, 2)
end

-- ============ UI SYSTEM ============
local BP = Color3.fromRGB(120, 130, 145)
local BDK = Color3.fromRGB(55, 60, 70)
local GRY = Color3.fromRGB(50, 55, 65)
local GREEN = Color3.fromRGB(45, 175, 85)
local RED = Color3.fromRGB(180, 45, 45)

local DM = { cur = nil, btn = nil, containers = {}, _optionDown = false }
function DM:close(imm)
    if not self.cur then return end
    local con = self.containers[self.cur]; local b = self.btn
    self.cur = nil; self.btn = nil
    if b and b.Parent then b.Active = true; b.AutoButtonColor = true; b.BackgroundColor3 = Color3.fromRGB(22, 24, 28); b.Interactable = true end
    if not con then return end
    if imm then con.Visible = false; return end
    local tw = TweenService:Create(con, TweenInfo.new(0.12), { Size = UDim2.new(0, con.AbsoluteSize.X, 0, 0) })
    tw:Play(); tw.Completed:Connect(function() con.Visible = false end)
end
function DM:open(ocName, oc, dd)
    if self.cur and self.cur ~= ocName then self:close(false) end
    self.cur = ocName; self.btn = dd; self.containers[ocName] = oc
    dd.Active = false; dd.AutoButtonColor = false; dd.BackgroundColor3 = Color3.fromRGB(35, 37, 42); dd.Interactable = false
end
UIS.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        if DM.cur then task.defer(function() if not DM._optionDown then DM:close(false) end; DM._optionDown = false end) end
    end
end)

local function rnd(v, s)
    if not s or s == 0 then return v end
    local d = 0; local st = tostring(s); local dot = st:find("%."); if dot then d = #st - dot end
    return math.floor(v * (10 ^ d) + 0.5) / (10 ^ d)
end

local function mkBox(par, title, x, y, w, h, iconId)
    local f = Instance.new("Frame", par)
    f.Size = UDim2.new(0, w, 0, h); f.Position = UDim2.new(0, x, 0, y)
    f.BackgroundColor3 = Color3.fromRGB(13, 14, 17); f.BorderSizePixel = 0; f.ZIndex = 10000
    local uic = Instance.new("UICorner", f); uic.CornerRadius = UDim.new(0, 12)
    local s = Instance.new("UIStroke", f); s.Color = BP; s.Thickness = 2; s.Transparency = 0.65
    if iconId then
        if type(iconId) == "number" then
            local ico = Instance.new("ImageLabel", f); ico.Name = "BoxIcon"
            ico.Size = UDim2.new(0, 16, 0, 16); ico.Position = UDim2.new(0, 7, 0, 8)
            ico.BackgroundTransparency = 1; ico.Image = "rbxassetid://" .. tostring(iconId)
            ico.ImageColor3 = Color3.fromRGB(200, 210, 220); ico.ScaleType = Enum.ScaleType.Fit
            ico.ZIndex = 10001
        elseif type(iconId) == "string" then
            local ico = Instance.new("TextLabel", f); ico.Name = "BoxIcon"
            ico.Size = UDim2.new(0, 18, 0, 18); ico.Position = UDim2.new(0, 6, 0, 7)
            ico.BackgroundTransparency = 1; ico.Text = iconId
            ico.TextColor3 = Color3.fromRGB(210, 130, 180); ico.Font = Enum.Font.GothamBold
            ico.TextSize = 14; ico.ZIndex = 10001
        end
    end
    local t = Instance.new("TextLabel", f); t.Name = "T"; t.Size = UDim2.new(1, -16, 0, 24)
    t.Position = iconId and UDim2.new(0, 28, 0, 4) or UDim2.new(0, 8, 0, 4)
    t.BackgroundTransparency = 1; t.Text = title; t.TextColor3 = Color3.fromRGB(210, 215, 220); t.Font = Enum.Font.GothamBold; t.TextSize = 12; t.TextXAlignment = Enum.TextXAlignment.Left
    return f
end

local function mkScroll(par, ch)
    local sc = Instance.new("ScrollingFrame", par)
    sc.Size = UDim2.new(1, -10, 1, -32); sc.Position = UDim2.new(0, 5, 0, 28)
    sc.BackgroundTransparency = 1; sc.BorderSizePixel = 0; sc.ScrollBarThickness = 4; sc.ScrollBarImageColor3 = Color3.fromRGB(120, 130, 145)
    sc.CanvasSize = UDim2.new(0, 0, 0, ch); return sc
end

local function mkToggle(par, text, key, y, cb)
    local f = Instance.new("Frame", par); f.Size = UDim2.new(1, -16, 0, 28); f.Position = UDim2.new(0, 8, 0, y); f.BackgroundTransparency = 1; f.ZIndex = 10000
    local l = Instance.new("TextLabel", f); l.Size = UDim2.new(0.65, 0, 1, 0); l.BackgroundTransparency = 1; l.Text = text; l.TextColor3 = Color3.fromRGB(200, 205, 210); l.Font = Enum.Font.GothamBold; l.TextSize = 11; l.TextXAlignment = Enum.TextXAlignment.Left
    local track = Instance.new("TextButton", f)
    track.Size = UDim2.new(0, 46, 0, 22); track.Position = UDim2.new(1, -46, 0.5, -11)
    track.BackgroundColor3 = Config[key] and GREEN or GRY
    track.Text = ""; track.AutoButtonColor = false; track.ZIndex = 10001
    Instance.new("UICorner", track).CornerRadius = UDim.new(0.5, 0)
    local knob = Instance.new("Frame", track)
    knob.Name = "Knob"
    knob.Size = UDim2.new(0, 16, 0, 16)
    knob.Position = Config[key] and UDim2.new(1, -19, 0.5, -8) or UDim2.new(0, 3, 0.5, -8)
    knob.BackgroundColor3 = Color3.fromRGB(255, 255, 255); knob.BorderSizePixel = 0; knob.ZIndex = 10002
    Instance.new("UICorner", knob).CornerRadius = UDim.new(0.5, 0)
    if key then _toggleRefs[key] = track end
    track.MouseButton1Click:Connect(function()
        Config[key] = not Config[key]
        local on = Config[key]
        TweenService:Create(track, TweenInfo.new(0.2, Enum.EasingStyle.Quad), { BackgroundColor3 = on and GREEN or GRY }):Play()
        TweenService:Create(knob, TweenInfo.new(0.2, Enum.EasingStyle.Quad), { Position = on and UDim2.new(1, -19, 0.5, -8) or UDim2.new(0, 3, 0.5, -8) }):Play()
        saveConfig(); notifyTog(text, on); if cb then cb(on) end
    end)
    return f, track
end

local function mkSlider(par, text, key, mn, mx, y, step, fmt, onchange)
    step = step or 1; if not fmt then fmt = function(v) return text .. ": " .. string.format("%g", v) end end
    local f = Instance.new("Frame", par); f.Size = UDim2.new(1, -16, 0, 40); f.Position = UDim2.new(0, 8, 0, y); f.BackgroundTransparency = 1; f.ZIndex = 10000
    local l = Instance.new("TextLabel", f); l.Size = UDim2.new(1, 0, 0, 16); l.BackgroundTransparency = 1; l.Text = fmt(rnd(Config[key], step)); l.TextColor3 = Color3.fromRGB(200, 205, 210); l.Font = Enum.Font.GothamBold; l.TextSize = 10; l.TextXAlignment = Enum.TextXAlignment.Left
    local bg = Instance.new("Frame", f); bg.Size = UDim2.new(1, 0, 0, 6); bg.Position = UDim2.new(0, 0, 0, 22); bg.BackgroundColor3 = Color3.fromRGB(28, 30, 35); bg.BorderSizePixel = 0; bg.ZIndex = 10000
    Instance.new("UICorner", bg).CornerRadius = UDim.new(0, 3)
    local fi = Instance.new("Frame", bg); fi.Size = UDim2.new((Config[key] - mn) / (mx - mn), 0, 1, 0); fi.BackgroundColor3 = BP; fi.BorderSizePixel = 0; fi.ZIndex = 10000
    Instance.new("UICorner", fi).CornerRadius = UDim.new(0, 3)
    local dr = false
    bg.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then dr = true end end)
    bg.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then dr = false end end)
    UIS.InputChanged:Connect(function(i)
        if dr and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
            local p = math.clamp((i.Position.X - bg.AbsolutePosition.X) / bg.AbsoluteSize.X, 0, 1)
            local v = rnd(math.clamp(math.floor((mn + (p * (mx - mn))) / step + 0.5) * step, mn, mx), step)
            Config[key] = v; fi.Size = UDim2.new((v - mn) / (mx - mn), 0, 1, 0); l.Text = fmt(v); saveConfig(); if onchange then onchange(v) end
        end
    end)
    return f
end

local function mkBtn(par, text, y, cb, col)
    local b = Instance.new("TextButton", par); b.Size = UDim2.new(1, -16, 0, 26); b.Position = UDim2.new(0, 8, 0, y)
    b.BackgroundColor3 = col or GRY; b.Text = text; b.TextColor3 = Color3.new(1, 1, 1); b.Font = Enum.Font.GothamBold; b.TextSize = 10; b.ZIndex = 10000
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 6)
    b.MouseButton1Click:Connect(cb); return b
end

local DropdownLayer = nil
local function getDropdownLayer() return DropdownLayer end

local function createDDButton(par, w, h)
    local dd = Instance.new("TextButton", par)
    dd.Size = UDim2.new(0, w, 0, h)
    dd.BackgroundColor3 = Color3.fromRGB(22, 24, 28)
    dd.TextColor3 = Color3.fromRGB(200, 205, 210); dd.Font = Enum.Font.GothamBold; dd.TextSize = 10; dd.ZIndex = 100000
    Instance.new("UICorner", dd).CornerRadius = UDim.new(0, 6)
    local stroke = Instance.new("UIStroke", dd)
    stroke.Color = Color3.fromRGB(80, 85, 95) -- Made outline brighter gray so it's more visible
    stroke.Thickness = 1.5 -- Increased thickness
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    return dd
end

local function mkDD(par, text, optsList, key, y, cb)
    local f = Instance.new("Frame", par); f.Size = UDim2.new(1, -16, 0, 26); f.Position = UDim2.new(0, 8, 0, y); f.BackgroundTransparency = 1; f.ZIndex = 10000
    local l = Instance.new("TextLabel", f); l.Size = UDim2.new(0.42, 0, 1, 0); l.BackgroundTransparency = 1; l.Text = text; l.TextColor3 = Color3.fromRGB(200, 205, 210); l.Font = Enum.Font.GothamBold; l.TextSize = 11; l.TextXAlignment = Enum.TextXAlignment.Left
    local dd = createDDButton(f, 0, 22)
    dd.Size = UDim2.new(0.56, 0, 0, 22); dd.Position = UDim2.new(0.43, 0, 0.5, -11)
    dd.Text = Config[key] and "v " .. tostring(Config[key]) or "v Select"
    local ocName = "OC_" .. text .. "_" .. tostring(tick())
    local oc = Instance.new("ScrollingFrame"); oc.Name = ocName; oc.BackgroundColor3 = Color3.fromRGB(18, 20, 24); oc.BorderSizePixel = 0; oc.Visible = false; oc.ZIndex = 2147483647; oc.ScrollBarThickness = 4; oc.ScrollBarImageColor3 = Color3.fromRGB(120, 130, 145); oc.Parent = getDropdownLayer()
    Instance.new("UICorner", oc).CornerRadius = UDim.new(0, 8)
    local stroke = Instance.new("UIStroke", oc); stroke.Color = Color3.fromRGB(80, 85, 95); stroke.Thickness = 1.5; stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    local currentOpts = {}
    local function fillOpts(opts)
        for _, c in pairs(oc:GetChildren()) do if c:IsA("TextButton") or c:IsA("TextLabel") then c:Destroy() end end
        if #opts == 0 then oc.CanvasSize = UDim2.new(0, 0, 0, 26); local nl = Instance.new("TextLabel", oc); nl.Size = UDim2.new(1, 0, 0, 26); nl.BackgroundTransparency = 1; nl.Text = "None"; nl.TextColor3 = Color3.fromRGB(100, 110, 130); nl.Font = Enum.Font.Gotham; nl.TextSize = 10; nl.ZIndex = 2147483647; nl.TextXAlignment = Enum.TextXAlignment.Center; return end
        currentOpts = opts; oc.CanvasSize = UDim2.new(0, 0, 0, #opts * 26)
        for i, opt in ipairs(opts) do
            local b = Instance.new("TextButton", oc); b.Size = UDim2.new(1, 0, 0, 26); b.Position = UDim2.new(0, 0, 0, (i - 1) * 26); b.BackgroundColor3 = Color3.fromRGB(18, 20, 24); b.Text = opt; b.TextColor3 = Color3.fromRGB(200, 205, 210); b.Font = Enum.Font.GothamBold; b.TextSize = 10; b.ZIndex = 2147483647
            Instance.new("UICorner", b).CornerRadius = UDim.new(0, 6)
            b.MouseButton1Down:Connect(function() DM._optionDown = true end)
            b.MouseButton1Click:Connect(function() Config[key] = opt; dd.Text = "v " .. opt; DM:close(false); saveConfig(); if cb then cb(opt) end end)
        end
    end
    fillOpts(type(optsList) == "function" and optsList() or optsList)
    dd.MouseButton1Down:Connect(function() DM._optionDown = true end)
    dd.MouseButton1Click:Connect(function()
        if DM.cur and DM.cur ~= ocName then DM:close(false) end
        if DM.cur == ocName then DM:close(false); return end
        if type(optsList) == "function" then fillOpts(optsList()) end
        local bp2 = dd.AbsolutePosition; local bs = dd.AbsoluteSize; local maxH = math.min(#currentOpts * 26, 200); if maxH <= 0 then maxH = 26 end
        oc.Position = UDim2.new(0, bp2.X, 0, bp2.Y + bs.Y + 2); oc.Size = UDim2.new(0, bs.X, 0, maxH); oc.Visible = true; DM:open(ocName, oc, dd)
    end)
    task.spawn(function() while dd and dd.Parent do task.wait(0.5); if Config[key] and dd.Text ~= "v " .. tostring(Config[key]) then dd.Text = "v " .. tostring(Config[key]) end end end)
    return f
end

local function mkMDD(par, text, optsList, cfgKey, y, cb)
    local f = Instance.new("Frame", par); f.Size = UDim2.new(1, -16, 0, 26); f.Position = UDim2.new(0, 8, 0, y); f.BackgroundTransparency = 1; f.ZIndex = 10000
    local l = Instance.new("TextLabel", f); l.Size = UDim2.new(0.42, 0, 1, 0); l.BackgroundTransparency = 1; l.Text = text; l.TextColor3 = Color3.fromRGB(200, 205, 210); l.Font = Enum.Font.GothamBold; l.TextSize = 11; l.TextXAlignment = Enum.TextXAlignment.Left
    local dd = createDDButton(f, 0, 22)
    dd.Size = UDim2.new(0.56, 0, 0, 22); dd.Position = UDim2.new(0.43, 0, 0.5, -11)
    local function getDisp() local s = Config[cfgKey]; if not s or #s == 0 then return "v None" elseif #s == 1 then return "v " .. s[1] else return "v " .. #s .. " selected" end end
    dd.Text = getDisp()
    local ocName = "MDD_" .. text .. "_" .. tostring(tick())
    local oc = Instance.new("ScrollingFrame"); oc.Name = ocName; oc.BackgroundColor3 = Color3.fromRGB(18, 20, 24); oc.BorderSizePixel = 0; oc.Visible = false; oc.ZIndex = 2147483647; oc.ScrollBarThickness = 4; oc.ScrollBarImageColor3 = Color3.fromRGB(120, 130, 145); oc.Parent = getDropdownLayer()
    Instance.new("UICorner", oc).CornerRadius = UDim.new(0, 8)
    local stroke2 = Instance.new("UIStroke", oc); stroke2.Color = Color3.fromRGB(80, 85, 95); stroke2.Thickness = 1.5; stroke2.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    local function isSel(opt) for _, v in pairs(Config[cfgKey]) do if v == opt then return true end end; return false end
    local currentOpts = {}
    local function fillOpts(opts)
        for _, c in pairs(oc:GetChildren()) do if c:IsA("TextButton") or c:IsA("TextLabel") then c:Destroy() end end
        if #opts == 0 then oc.CanvasSize = UDim2.new(0, 0, 0, 26); local nl = Instance.new("TextLabel", oc); nl.Size = UDim2.new(1, 0, 0, 26); nl.BackgroundTransparency = 1; nl.Text = "None"; nl.TextColor3 = Color3.fromRGB(100, 110, 130); nl.Font = Enum.Font.Gotham; nl.TextSize = 10; nl.ZIndex = 2147483647; nl.TextXAlignment = Enum.TextXAlignment.Center; return end
        currentOpts = opts; oc.CanvasSize = UDim2.new(0, 0, 0, #opts * 26)
        for i, opt in ipairs(opts) do
            local b = Instance.new("TextButton", oc); b.Size = UDim2.new(1, 0, 0, 26); b.Position = UDim2.new(0, 0, 0, (i - 1) * 26)
            b.BackgroundColor3 = isSel(opt) and Color3.fromRGB(55, 60, 70) or Color3.fromRGB(18, 20, 24); b.Text = (isSel(opt) and "v " or "  ") .. opt; b.TextColor3 = Color3.fromRGB(200, 205, 210); b.Font = Enum.Font.GothamBold; b.TextSize = 10; b.ZIndex = 2147483647
            Instance.new("UICorner", b).CornerRadius = UDim.new(0, 6)
            b.MouseButton1Down:Connect(function() DM._optionDown = true end)
            b.MouseButton1Click:Connect(function()
                local sel = Config[cfgKey]; local found = false
                for idx, v in pairs(sel) do if v == opt then table.remove(sel, idx); found = true; break end end
                if not found then table.insert(sel, opt) end; Config[cfgKey] = sel
                b.BackgroundColor3 = isSel(opt) and Color3.fromRGB(55, 60, 70) or Color3.fromRGB(18, 20, 24); b.Text = (isSel(opt) and "v " or "  ") .. opt
                dd.Text = getDisp(); saveConfig(); if cb then cb(sel) end
            end)
        end
    end
    fillOpts(type(optsList) == "function" and optsList() or optsList)
    dd.MouseButton1Down:Connect(function() DM._optionDown = true end)
    dd.MouseButton1Click:Connect(function()
        if DM.cur and DM.cur ~= ocName then DM:close(false) end
        if DM.cur == ocName then DM:close(false); return end
        if type(optsList) == "function" then fillOpts(optsList()) end
        local bp2 = dd.AbsolutePosition; local bs = dd.AbsoluteSize; local maxH = math.min(#currentOpts * 26, 200); if maxH <= 0 then maxH = 26 end
        oc.Position = UDim2.new(0, bp2.X, 0, bp2.Y + bs.Y + 2); oc.Size = UDim2.new(0, bs.X, 0, maxH); oc.Visible = true; DM:open(ocName, oc, dd)
    end)
    task.spawn(function() while dd and dd.Parent do task.wait(1); dd.Text = getDisp() end end)
    return f
end

local function mkTab(par, iconId, name, idx, cb)
    local b = Instance.new("TextButton", par); b.Name = name .. "Btn"; b.Size = UDim2.new(1, -8, 0, 42); b.Position = UDim2.new(0, 4, 0, (idx - 1) * 46 + 5)
    b.BackgroundColor3 = idx == 1 and BDK or Color3.fromRGB(18, 20, 24); b.Text = ""; b.Font = Enum.Font.GothamBold; b.TextSize = 9; b.ZIndex = 10000
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 10)
    local img = Instance.new("ImageLabel", b); img.Name = "TabIcon"; img.Size = UDim2.new(0, 24, 0, 24); img.Position = UDim2.new(0.5, -12, 0.5, -12); img.BackgroundTransparency = 1; img.Image = "rbxassetid://" .. tostring(iconId); img.ImageColor3 = idx == 1 and Color3.fromRGB(255, 255, 255) or Color3.fromRGB(100, 105, 115); img.ZIndex = 10001; img.ScaleType = Enum.ScaleType.Fit
    b.MouseButton1Click:Connect(function() cb(); DM:close(false) end)
    return b
end

-- ============ BUILD UI ============
local function buildUI()
    if CoreGui:FindFirstChild("CloudyzHub") then CoreGui:FindFirstChild("CloudyzHub"):Destroy() end
    local sg = Instance.new("ScreenGui"); sg.Name = "CloudyzHub"; sg.ResetOnSpawn = false; sg.IgnoreGuiInset = true; sg.ZIndexBehavior = Enum.ZIndexBehavior.Sibling; sg.Parent = CoreGui
    MainUI = sg; DropdownLayer = sg

    local bgf = Instance.new("Frame", sg); bgf.Name = "BG"; bgf.Size = UDim2.new(0, 575, 0, 380); bgf.Position = UDim2.new(0.5, -287, 0.5, -190); bgf.BackgroundColor3 = Color3.fromRGB(11, 12, 15); bgf.BorderSizePixel = 0; bgf.ClipsDescendants = false
    local uic_main = Instance.new("UICorner", bgf); uic_main.CornerRadius = UDim.new(0, 14)
    local bgs = Instance.new("UIStroke", bgf); bgs.Color = Color3.fromRGB(75, 80, 95); bgs.Thickness = 2.5; bgs.Transparency = 0.15

    local tb = Instance.new("Frame", bgf); tb.Size = UDim2.new(1, 0, 0, 50); tb.BackgroundColor3 = Color3.fromRGB(13, 14, 17); tb.BorderSizePixel = 0; tb.ZIndex = 10001
    local tbuic = Instance.new("UICorner", tb); tbuic.CornerRadius = UDim.new(0, 14)
    local tbFill = Instance.new("Frame", tb); tbFill.Size = UDim2.new(1, 0, 0, 20); tbFill.Position = UDim2.new(0, 0, 1, -20); tbFill.BackgroundColor3 = Color3.fromRGB(13, 14, 17); tbFill.BorderSizePixel = 0; tbFill.ZIndex = 10000

    local drag, ds, sp = false, nil, nil
    tb.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
            drag = true; ds = i.Position; sp = bgf.Position; DM:close(true)
            i.Changed:Connect(function() if i.UserInputState == Enum.UserInputState.End then drag = false end end)
        end
    end)
    UIS.InputChanged:Connect(function(i)
        if drag and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
            local d = i.Position - ds; bgf.Position = UDim2.new(sp.X.Scale, sp.X.Offset + d.X, sp.Y.Scale, sp.Y.Offset + d.Y)
        end
    end)

    local ci = Instance.new("TextLabel", tb); ci.Name = "TitleCloud"; ci.Size = UDim2.new(0, 28, 0, 32); ci.Position = UDim2.new(0, 10, 0, 9)
    ci.BackgroundTransparency = 1; ci.Text = utf8.char(0x2601); ci.TextColor3 = Color3.fromRGB(180, 210, 255); ci.Font = Enum.Font.GothamBold; ci.TextSize = 22; ci.ZIndex = 10002

    local tl = Instance.new("TextLabel", tb); tl.Size = UDim2.new(0, 340, 0, 22); tl.Position = UDim2.new(0, 42, 0, 8); tl.BackgroundTransparency = 1; tl.Text = "Cloudyz Hub v1.0"; tl.TextColor3 = Color3.fromRGB(210, 215, 220); tl.Font = Enum.Font.GothamBold; tl.TextSize = 16; tl.TextXAlignment = Enum.TextXAlignment.Left; tl.ZIndex = 10002
    local sl = Instance.new("TextLabel", tb); sl.Size = UDim2.new(0, 500, 0, 14); sl.Position = UDim2.new(0, 42, 0, 30); sl.BackgroundTransparency = 1; sl.Text = "Garden Horizons | RightShift to toggle"; sl.TextColor3 = Color3.fromRGB(160, 165, 175); sl.Font = Enum.Font.Gotham; sl.TextSize = 9; sl.TextXAlignment = Enum.TextXAlignment.Left; sl.ZIndex = 10002
    local xb = Instance.new("TextButton", tb); xb.Size = UDim2.new(0, 32, 0, 32); xb.Position = UDim2.new(1, -40, 0, 9); xb.BackgroundColor3 = Color3.fromRGB(175, 45, 45); xb.Text = "x"; xb.TextColor3 = Color3.new(1, 1, 1); xb.Font = Enum.Font.GothamBold; xb.TextSize = 16; xb.ZIndex = 10002
    Instance.new("UICorner", xb).CornerRadius = UDim.new(0, 8)
    xb.MouseButton1Click:Connect(function() TweenService:Create(bgf, TweenInfo.new(0.2), { Size = UDim2.new(0, 0, 0, 0) }):Play(); task.wait(0.2); sg.Enabled = false; if MiniUI then MiniUI.Enabled = true end end)

    local titleSep = Instance.new("Frame", bgf); titleSep.Size = UDim2.new(1, 0, 0, 1); titleSep.Position = UDim2.new(0, 0, 0, 50); titleSep.BackgroundColor3 = Color3.fromRGB(45, 48, 58); titleSep.BorderSizePixel = 0; titleSep.ZIndex = 10005
    local sidebar = Instance.new("Frame", bgf); sidebar.Name = "SB"; sidebar.Size = UDim2.new(0, 55, 1, -50); sidebar.Position = UDim2.new(0, 0, 0, 50); sidebar.BackgroundColor3 = Color3.fromRGB(13, 14, 17); sidebar.BorderSizePixel = 0; sidebar.ZIndex = 10000
    local sbUIC = Instance.new("UICorner", sidebar); sbUIC.CornerRadius = UDim.new(0, 14)
    local sbFill = Instance.new("Frame", sidebar); sbFill.Size = UDim2.new(1, 0, 0, 20); sbFill.Position = UDim2.new(0, 0, 0, 0); sbFill.BackgroundColor3 = Color3.fromRGB(13, 14, 17); sbFill.BorderSizePixel = 0; sbFill.ZIndex = 9999
    local sbFill2 = Instance.new("Frame", sidebar); sbFill2.Size = UDim2.new(0, 20, 1, 0); sbFill2.Position = UDim2.new(1, -20, 0, 0); sbFill2.BackgroundColor3 = Color3.fromRGB(13, 14, 17); sbFill2.BorderSizePixel = 0; sbFill2.ZIndex = 9999

    local contentFrame = Instance.new("Frame", bgf); contentFrame.Size = UDim2.new(1, -60, 1, -55); contentFrame.Position = UDim2.new(0, 58, 0, 52); contentFrame.BackgroundTransparency = 1; contentFrame.ClipsDescendants = true
    local ms = Instance.new("ScrollingFrame", contentFrame); ms.Size = UDim2.new(1, 0, 1, 0); ms.BackgroundTransparency = 1; ms.BorderSizePixel = 0; ms.ScrollBarThickness = 6; ms.ScrollBarImageColor3 = Color3.fromRGB(120, 130, 145); ms.CanvasSize = UDim2.new(0, 0, 0, 600); ms.ScrollingDirection = Enum.ScrollingDirection.Y
    local cf = Instance.new("Frame", ms); cf.Size = UDim2.new(1, -6, 0, 1200); cf.BackgroundTransparency = 1

    local sbFrame = mkBox(cf, "", 0, 0, 495, 44)
    StatusLabel = sbFrame:FindFirstChild("T")
    StatusLabel.Size = UDim2.new(1, -16, 0, 36); StatusLabel.Position = UDim2.new(0, 8, 0, 4)
    StatusLabel.Text = "Plot: ? | Seeds: 0 | Plants: 0 | Idle"; StatusLabel.TextXAlignment = Enum.TextXAlignment.Left; StatusLabel.TextSize = 11

    local pages, pageSizes = {}, {}

    -- ==================== TAB 1: FARM ====================
    local fp = Instance.new("Frame", cf); fp.Name = "Farm"; fp.Size = UDim2.new(1, 0, 0, 1100); fp.Position = UDim2.new(0, 0, 0, 50); fp.BackgroundTransparency = 1; fp.Visible = true

    local plBox = mkBox(fp, "Auto Plant", 0, 0, 245, 272, 10734965572); local plSc = mkScroll(plBox, 255); local yo = 0
    mkToggle(plSc, "Auto Plant", "autoPlant", yo, function(e)
        if e then warnTPGarden(); startLoop("plant", Config.plantInterval + 0.5, autoPlant)
        else stopLoop("plant"); autoPlantRunning = false; releaseToolMutex(); task.delay(0.2, function() pcall(unequipAll) end) end
    end); yo = yo + 30
    do
        local f = Instance.new("Frame", plSc); f.Size = UDim2.new(1,-16,0,26); f.Position = UDim2.new(0,8,0,yo); f.BackgroundTransparency=1; f.ZIndex=10000
        local l = Instance.new("TextLabel", f); l.Size=UDim2.new(0.42,0,1,0); l.BackgroundTransparency=1; l.Text="Mode"; l.TextColor3=Color3.fromRGB(200,205,210); l.Font=Enum.Font.GothamBold; l.TextSize=11; l.TextXAlignment=Enum.TextXAlignment.Left
        local dd = createDDButton(f, 0, 22); dd.Size=UDim2.new(0.56,0,0,22); dd.Position=UDim2.new(0.43,0,0.5,-11)
        dd.Text = "v " .. Config.plantSeedMode
        local ocName = "OC_PlantMode_" .. tostring(tick()); local oc = Instance.new("ScrollingFrame"); oc.BackgroundColor3=Color3.fromRGB(18,20,24); oc.BorderSizePixel=0; oc.Visible=false; oc.ZIndex=2147483647; oc.ScrollBarThickness=4; oc.Parent=sg
        Instance.new("UICorner", oc).CornerRadius = UDim.new(0,8)
        local modeOpts = {"Seed in Inv","All Seed","Select Seed"}; oc.CanvasSize=UDim2.new(0,0,0,#modeOpts*26)
        for i, opt in ipairs(modeOpts) do
            local b=Instance.new("TextButton",oc); b.Size=UDim2.new(1,0,0,26); b.Position=UDim2.new(0,0,0,(i-1)*26); b.BackgroundColor3=Color3.fromRGB(18,20,24); b.Text=opt; b.TextColor3=Color3.fromRGB(200,205,210); b.Font=Enum.Font.GothamBold; b.TextSize=10; b.ZIndex=2147483647
            Instance.new("UICorner",b).CornerRadius=UDim.new(0,6)
            b.MouseButton1Down:Connect(function() DM._optionDown=true end)
            b.MouseButton1Click:Connect(function() Config.plantSeedMode=opt; dd.Text="v "..opt; DM:close(false); saveConfig() end)
        end
        dd.MouseButton1Down:Connect(function() DM._optionDown=true end)
        dd.MouseButton1Click:Connect(function()
            if DM.cur and DM.cur~=ocName then DM:close(false) end
            if DM.cur==ocName then DM:close(false); return end
            local bp2=dd.AbsolutePosition; local bs=dd.AbsoluteSize; oc.Position=UDim2.new(0,bp2.X,0,bp2.Y+bs.Y+2); oc.Size=UDim2.new(0,bs.X,0,#modeOpts*26); oc.Visible=true; DM:open(ocName,oc,dd)
        end)
        task.spawn(function() while dd and dd.Parent do task.wait(0.3); if dd.Text~="v "..Config.plantSeedMode then dd.Text="v "..Config.plantSeedMode end end end)
    end
    yo = yo + 28
    local seedSubContainer = Instance.new("Frame", plSc); seedSubContainer.Size=UDim2.new(1,-16,0,26); seedSubContainer.Position=UDim2.new(0,8,0,yo); seedSubContainer.BackgroundTransparency=1; seedSubContainer.ZIndex=10000
    local function rebuildSeedSub(mode)
        for _, c in pairs(seedSubContainer:GetChildren()) do c:Destroy() end
        if mode == "Seed in Inv" then
            local l=Instance.new("TextLabel",seedSubContainer); l.Size=UDim2.new(0.42,0,1,0); l.BackgroundTransparency=1; l.Text="Seeds"; l.TextColor3=Color3.fromRGB(200,205,210); l.Font=Enum.Font.GothamBold; l.TextSize=11; l.TextXAlignment=Enum.TextXAlignment.Left
            local dd=createDDButton(seedSubContainer, 0, 22); dd.Size=UDim2.new(0.56,0,0,22); dd.Position=UDim2.new(0.43,0,0.5,-11)
            local function getDisp() local s=Config.selectedSeeds; if not s or #s==0 then return "v None" elseif #s==1 then return "v "..s[1] else return "v "..#s.." sel" end end
            dd.Text = getDisp()
            local ocName="MDDSINV_"..tostring(tick()); local oc=Instance.new("ScrollingFrame"); oc.BackgroundColor3=Color3.fromRGB(18, 20, 24); oc.BorderSizePixel=0; oc.Visible=false; oc.ZIndex=2147483647; oc.ScrollBarThickness=4; oc.Parent=sg
            Instance.new("UICorner",oc).CornerRadius=UDim.new(0,8)
            local str1 = Instance.new("UIStroke", oc); str1.Color = Color3.fromRGB(80, 85, 95); str1.Thickness = 1.5; str1.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
            local function isSel(opt) for _,v in pairs(Config.selectedSeeds) do if v==opt then return true end end; return false end
            local cOpts={}
            local function fillOpts()
                local opts=getSeedNames(); cOpts=opts
                for _,c in pairs(oc:GetChildren()) do if c:IsA("TextButton") or c:IsA("TextLabel") then c:Destroy() end end
                oc.CanvasSize=UDim2.new(0,0,0,math.max(#opts,1)*26)
                if #opts==0 then local nl=Instance.new("TextLabel",oc); nl.Size=UDim2.new(1,0,0,26); nl.BackgroundTransparency=1; nl.Text="No seeds in inv"; nl.TextColor3=Color3.fromRGB(100,110,130); nl.Font=Enum.Font.Gotham; nl.TextSize=10; nl.ZIndex=2147483647; nl.TextXAlignment=Enum.TextXAlignment.Center; return end
                for i,opt in ipairs(opts) do
                    local b=Instance.new("TextButton",oc); b.Size=UDim2.new(1,0,0,26); b.Position=UDim2.new(0,0,0,(i-1)*26); b.BackgroundColor3=isSel(opt) and Color3.fromRGB(55,60,70) or Color3.fromRGB(18,20,24); b.Text=(isSel(opt) and "v " or "  ")..opt; b.TextColor3=Color3.fromRGB(200,205,210); b.Font=Enum.Font.GothamBold; b.TextSize=10; b.ZIndex=2147483647
                    Instance.new("UICorner",b).CornerRadius=UDim.new(0,6)
                    b.MouseButton1Down:Connect(function() DM._optionDown=true end)
                    b.MouseButton1Click:Connect(function()
                        local sel=Config.selectedSeeds; local found=false; for idx,v in pairs(sel) do if v==opt then table.remove(sel,idx); found=true; break end end; if not found then table.insert(sel,opt) end; Config.selectedSeeds=sel
                        b.BackgroundColor3=isSel(opt) and Color3.fromRGB(55,60,70) or Color3.fromRGB(18,20,24); b.Text=(isSel(opt) and "v " or "  ")..opt; dd.Text=getDisp(); saveConfig()
                    end)
                end
            end
            fillOpts()
            dd.MouseButton1Down:Connect(function() DM._optionDown=true end)
            dd.MouseButton1Click:Connect(function()
                if DM.cur and DM.cur~=ocName then DM:close(false) end; if DM.cur==ocName then DM:close(false); return end
                fillOpts(); local bp2=dd.AbsolutePosition; local bs=dd.AbsoluteSize; local maxH=math.min(math.max(#cOpts,1)*26,200)
                oc.Position=UDim2.new(0,bp2.X,0,bp2.Y+bs.Y+2); oc.Size=UDim2.new(0,bs.X,0,maxH); oc.Visible=true; DM:open(ocName,oc,dd)
            end)
            task.spawn(function() while dd and dd.Parent do task.wait(1); dd.Text=getDisp() end end)
        elseif mode == "All Seed" then
            local lbl=Instance.new("TextLabel",seedSubContainer); lbl.Size=UDim2.new(1,0,1,0); lbl.BackgroundTransparency=1; lbl.Text="Plants all seeds in inventory"; lbl.Font=Enum.Font.Gotham; lbl.TextColor3=Color3.fromRGB(80,200,120); lbl.TextSize=10; lbl.TextXAlignment=Enum.TextXAlignment.Left
        elseif mode == "Select Seed" then
            local l=Instance.new("TextLabel",seedSubContainer); l.Size=UDim2.new(0.42,0,1,0); l.BackgroundTransparency=1; l.Text="Seeds"; l.TextColor3=Color3.fromRGB(200,205,210); l.Font=Enum.Font.GothamBold; l.TextSize=11; l.TextXAlignment=Enum.TextXAlignment.Left
            local dd=createDDButton(seedSubContainer, 0, 22); dd.Size=UDim2.new(0.56,0,0,22); dd.Position=UDim2.new(0.43,0,0.5,-11)
            local function getDisp() local s=Config.selectedSeedsFull; if not s or #s==0 then return "v None" elseif #s==1 then return "v "..s[1] else return "v "..#s.." sel" end end
            dd.Text=getDisp()
            local ocName="MDDSFULL_"..tostring(tick()); local oc=Instance.new("ScrollingFrame"); oc.BackgroundColor3=Color3.fromRGB(18,20,24); oc.BorderSizePixel=0; oc.Visible=false; oc.ZIndex=2147483647; oc.ScrollBarThickness=4; oc.Parent=sg
            Instance.new("UICorner",oc).CornerRadius=UDim.new(0,8)
            local str2 = Instance.new("UIStroke", oc); str2.Color = Color3.fromRGB(80, 85, 95); str2.Thickness = 1.5; str2.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
            local function isSel(opt) for _,v in pairs(Config.selectedSeedsFull) do if v==opt then return true end end; return false end
            local function fillOpts()
                for _,c in pairs(oc:GetChildren()) do if c:IsA("TextButton") or c:IsA("TextLabel") then c:Destroy() end end
                local allSeeds=getAllSeedNamesCached(); oc.CanvasSize=UDim2.new(0,0,0,#allSeeds*26)
                for i,opt in ipairs(allSeeds) do
                    local b=Instance.new("TextButton",oc); b.Size=UDim2.new(1,0,0,26); b.Position=UDim2.new(0,0,0,(i-1)*26); b.BackgroundColor3=isSel(opt) and Color3.fromRGB(55,60,70) or Color3.fromRGB(18,20,24); b.Text=(isSel(opt) and "v " or "  ")..opt; b.TextColor3=Color3.fromRGB(200,205,210); b.Font=Enum.Font.GothamBold; b.TextSize=10; b.ZIndex=2147483647
                    Instance.new("UICorner",b).CornerRadius=UDim.new(0,6)
                    b.MouseButton1Down:Connect(function() DM._optionDown=true end)
                    b.MouseButton1Click:Connect(function()
                        local sel=Config.selectedSeedsFull; local found=false; for idx,v in pairs(sel) do if v==opt then table.remove(sel,idx); found=true; break end end; if not found then table.insert(sel,opt) end; Config.selectedSeedsFull=sel
                        b.BackgroundColor3=isSel(opt) and Color3.fromRGB(55,60,70) or Color3.fromRGB(18,20,24); b.Text=(isSel(opt) and "v " or "  ")..opt; dd.Text=getDisp(); saveConfig()
                    end)
                end
            end
            fillOpts()
            dd.MouseButton1Down:Connect(function() DM._optionDown=true end)
            dd.MouseButton1Click:Connect(function()
                if DM.cur and DM.cur~=ocName then DM:close(false) end; if DM.cur==ocName then DM:close(false); return end
                _allSeedCache=nil; fillOpts(); local allSeeds=getAllSeedNamesCached(); local bp2=dd.AbsolutePosition; local bs=dd.AbsoluteSize; local maxH=math.min(#allSeeds*26,200)
                oc.Position=UDim2.new(0,bp2.X,0,bp2.Y+bs.Y+2); oc.Size=UDim2.new(0,bs.X,0,maxH); oc.Visible=true; DM:open(ocName,oc,dd)
            end)
            task.spawn(function() while dd and dd.Parent do task.wait(1); dd.Text=getDisp() end end)
        end
    end
    rebuildSeedSub(Config.plantSeedMode)
    task.spawn(function() local lastMode=Config.plantSeedMode; while plSc and plSc.Parent do task.wait(0.3); if Config.plantSeedMode~=lastMode then lastMode=Config.plantSeedMode; rebuildSeedSub(lastMode) end end end)
    yo = yo + 28
    mkSlider(plSc, "Amount", "plantAmount", 1, 51, yo, 1, function(v) return v>=51 and "Amount: Max" or "Amount: "..string.format("%g",v) end); yo=yo+42
    mkSlider(plSc, "Interval", "plantInterval", 0, 1, yo, 0.05, function(v) return v==0 and "Interval: Instant" or "Interval: "..string.format("%g",v).."s" end); yo=yo+42
    mkBtn(plSc, "Plant Now", yo, function() task.spawn(autoPlant) end, GREEN); plSc.CanvasSize=UDim2.new(0,0,0,yo+34)

    local seBox = mkBox(fp, "Auto Sell", 0, 278, 245, 142, 10709811110); local seSc = mkScroll(seBox, 115); yo=0
    mkToggle(seSc, "Auto Sell", "autoSell", yo, function(e) if e then startLoop("sell", Config.sellInterval, doSell) else stopLoop("sell") end end); yo=yo+30
    mkSlider(seSc, "Interval", "sellInterval", 10, 300, yo, 5, function(v) return "Interval: "..string.format("%g",v).."s" end, function(v)
        if Config.autoSell then startLoop("sell", v, doSell) end
    end); yo=yo+42
    mkBtn(seSc, "Sell Now", yo, function() task.spawn(doSell) end, GREEN)

    local favBox = mkBox(fp, "Auto Favorite", 0, 426, 245, 118, "â™¥"); local favSc = mkScroll(favBox, 100); yo=0
    mkDD(favSc, "Type", {"Seed","Plant"}, "autoFavoriteType", yo, function(t)
        Config.selectedFavoritePlant = ""
    end); yo=yo+28
    do
        local f=Instance.new("Frame",favSc); f.Size=UDim2.new(1,-16,0,26); f.Position=UDim2.new(0,8,0,yo); f.BackgroundTransparency=1; f.ZIndex=10000
        local l=Instance.new("TextLabel",f); l.Size=UDim2.new(0.42,0,1,0); l.BackgroundTransparency=1; l.Text="Select"; l.TextColor3=Color3.fromRGB(200,205,210); l.Font=Enum.Font.GothamBold; l.TextSize=11; l.TextXAlignment=Enum.TextXAlignment.Left
        local dd=createDDButton(f, 0, 22); dd.Size=UDim2.new(0.56,0,0,22); dd.Position=UDim2.new(0.43,0,0.5,-11)
        dd.Text = Config.selectedFavoritePlant ~= "" and "v "..Config.selectedFavoritePlant or "v Select"
        local ocName="FAV_DD_"..tostring(tick()); local oc=Instance.new("ScrollingFrame"); oc.BackgroundColor3=Color3.fromRGB(18,20,24); oc.BorderSizePixel=0; oc.Visible=false; oc.ZIndex=2147483647; oc.ScrollBarThickness=4; oc.Parent=sg
        Instance.new("UICorner",oc).CornerRadius=UDim.new(0,8)
        local str3 = Instance.new("UIStroke", oc); str3.Color = Color3.fromRGB(80, 85, 95); str3.Thickness = 1.5; str3.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        local cOpts={}
        local function fillFavOpts()
            local opts = Config.autoFavoriteType == "Seed" and getClientPlantTypes() or getInventoryPlantNames()
            cOpts=opts
            for _,c in pairs(oc:GetChildren()) do if c:IsA("TextButton") or c:IsA("TextLabel") then c:Destroy() end end
            oc.CanvasSize=UDim2.new(0,0,0,math.max(#opts,1)*26)
            if #opts==0 then local nl=Instance.new("TextLabel",oc); nl.Size=UDim2.new(1,0,0,26); nl.BackgroundTransparency=1; nl.Text="None found"; nl.TextColor3=Color3.fromRGB(100,110,130); nl.Font=Enum.Font.Gotham; nl.TextSize=10; nl.ZIndex=2147483647; nl.TextXAlignment=Enum.TextXAlignment.Center; return end
            for i,opt in ipairs(opts) do
                local b=Instance.new("TextButton",oc); b.Size=UDim2.new(1,0,0,26); b.Position=UDim2.new(0,0,0,(i-1)*26); b.BackgroundColor3=Color3.fromRGB(18,20,24); b.Text=opt; b.TextColor3=Color3.fromRGB(200,205,210); b.Font=Enum.Font.GothamBold; b.TextSize=10; b.ZIndex=2147483647
                Instance.new("UICorner",b).CornerRadius=UDim.new(0,6)
                b.MouseButton1Down:Connect(function() DM._optionDown=true end)
                b.MouseButton1Click:Connect(function() Config.selectedFavoritePlant=opt; dd.Text="v "..opt; DM:close(false); saveConfig() end)
            end
        end
        fillFavOpts()
        dd.MouseButton1Down:Connect(function() DM._optionDown=true end)
        dd.MouseButton1Click:Connect(function()
            if DM.cur and DM.cur~=ocName then DM:close(false) end; if DM.cur==ocName then DM:close(false); return end
            fillFavOpts(); local bp2=dd.AbsolutePosition; local bs=dd.AbsoluteSize; local maxH=math.min(math.max(#cOpts,1)*26,200)
            oc.Position=UDim2.new(0,bp2.X,0,bp2.Y+bs.Y+2); oc.Size=UDim2.new(0,bs.X,0,maxH); oc.Visible=true; DM:open(ocName,oc,dd)
        end)
    end
    yo=yo+28
    mkToggle(favSc, "Auto Favorite Selected", "autoFavorite", yo, function(e)
        if e then warnTPGarden(); startLoop("autoFav", 3, doAutoFavorite) else stopLoop("autoFav") end
    end); favSc.CanvasSize=UDim2.new(0,0,0,yo+34)

    local waBox = mkBox(fp, "Water & Sprinkler", 250, 0, 245, 310, 10723344432); local waSc = mkScroll(waBox, 290); yo=0
    local waSepL=Instance.new("TextLabel",waSc); waSepL.Size=UDim2.new(1,-8,0,14); waSepL.Position=UDim2.new(0,4,0,yo); waSepL.BackgroundTransparency=1; waSepL.Text="--- Auto Water ---"; waSepL.TextColor3=Color3.fromRGB(140,148,160); waSepL.Font=Enum.Font.GothamBold; waSepL.TextSize=9; waSepL.TextXAlignment=Enum.TextXAlignment.Center; yo=yo+16
    mkToggle(waSc, "Auto Water", "autoWater", yo, function(e) if e then warnTPGarden(); startLoop("water", Config.waterInterval, autoWater) else stopLoop("water"); autoWaterRunning=false end end); yo=yo+30
    mkSlider(waSc, "Interval", "waterInterval", 1, 120, yo, 1, function(v) return "Water Every: "..v.."s" end); yo=yo+42
    mkDD(waSc, "Mode", {"All","Select"}, "waterMode", yo); yo=yo+28
    mkMDD(waSc, "Plants", function() return getPlantNames(false) end, "selectedWaterPlants", yo); yo=yo+30
    local divF=Instance.new("Frame",waSc); divF.Size=UDim2.new(1,-16,0,1); divF.Position=UDim2.new(0,8,0,yo); divF.BackgroundColor3=Color3.fromRGB(40,42,48); divF.BorderSizePixel=0; yo=yo+8
    local spSepL=Instance.new("TextLabel",waSc); spSepL.Size=UDim2.new(1,-8,0,14); spSepL.Position=UDim2.new(0,4,0,yo); spSepL.BackgroundTransparency=1; spSepL.Text="--- Auto Sprinkler ---"; spSepL.TextColor3=Color3.fromRGB(140,148,160); spSepL.Font=Enum.Font.GothamBold; spSepL.TextSize=9; spSepL.TextXAlignment=Enum.TextXAlignment.Center; yo=yo+16
    mkToggle(waSc, "Auto Sprinkler", "autoSprinkler", yo, function(e) if e then warnTPGarden(); startLoop("sprinkler", Config.sprinklerInterval, autoPlaceSprinkler) else stopLoop("sprinkler"); autoSprinklerRunning=false end end); yo=yo+30
    mkSlider(waSc, "Interval", "sprinklerInterval", 1, 120, yo, 1, function(v) return "Sprinkler Every: "..v.."s" end); yo=yo+42
    mkDD(waSc, "Sprinkler", SPRINKLER_LIST, "sprinklerName", yo); yo=yo+28
    mkDD(waSc, "Put On", {"Random","Player Position","All Plants"}, "sprinklerPutMode", yo); yo=yo+28
    mkBtn(waSc, "Place Now", yo, function() task.spawn(autoPlaceSprinkler) end, GREEN); waSc.CanvasSize=UDim2.new(0,0,0,yo+34)

    local coBox = mkBox(fp, "Auto Collect", 250, 316, 245, 228, 10734965572)
    local coFr = Instance.new("Frame", coBox); coFr.Size = UDim2.new(1,-10,1,-32); coFr.Position = UDim2.new(0,5,0,28); coFr.BackgroundTransparency=1; yo=0
    mkToggle(coFr, "Auto Collect", "autoCollect", yo, function(e) if e then warnTPGarden(); startLoop("collect", 2, autoCollect) else stopLoop("collect"); autoCollectRunning=false end end); yo=yo+30
    mkDD(coFr, "Mode", {"All","Select"}, "collectMode", yo); yo=yo+28
    mkMDD(coFr, "Plants", function() return getPlantNames(false) end, "selectedCollectPlants", yo); yo=yo+28
    do
        local f2=Instance.new("Frame",coFr); f2.Size=UDim2.new(1,-16,0,26); f2.Position=UDim2.new(0,8,0,yo); f2.BackgroundTransparency=1; f2.ZIndex=10000
        local mutLabel=Instance.new("TextLabel",f2); mutLabel.Size=UDim2.new(0.42,0,1,0); mutLabel.BackgroundTransparency=1; mutLabel.Text="Mutations"; mutLabel.TextColor3=Color3.fromRGB(200,205,210); mutLabel.Font=Enum.Font.GothamBold; mutLabel.TextSize=11; mutLabel.TextXAlignment=Enum.TextXAlignment.Left
        local dd=createDDButton(f2, 0, 22); dd.Size=UDim2.new(0.56,0,0,22); dd.Position=UDim2.new(0.43,0,0.5,-11)
        local function getDisp() local s=Config.filterMutations; if not s or #s==0 then return "v None" elseif #s==1 then return "v "..s[1] else return "v "..#s.." selected" end end
        dd.Text=getDisp()
        local ocName="MDD_filterMutations_"..tostring(tick()); local oc=Instance.new("ScrollingFrame"); oc.BackgroundColor3=Color3.fromRGB(18,20,24); oc.BorderSizePixel=0; oc.Visible=false; oc.ZIndex=2147483647; oc.ScrollBarThickness=4; oc.Parent=sg
        Instance.new("UICorner",oc).CornerRadius=UDim.new(0,8)
        local str4 = Instance.new("UIStroke", oc); str4.Color = Color3.fromRGB(80, 85, 95); str4.Thickness = 1.5; str4.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        local function isSel(opt) for _,v in pairs(Config.filterMutations) do if v==opt then return true end end; return false end
        local function fillMutOpts()
            for _,c in pairs(oc:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
            oc.CanvasSize=UDim2.new(0,0,0,#MUTATION_LIST*26)
            for i,opt in ipairs(MUTATION_LIST) do
                local b=Instance.new("TextButton",oc); b.Size=UDim2.new(1,0,0,26); b.Position=UDim2.new(0,0,0,(i-1)*26); b.BackgroundColor3=isSel(opt) and Color3.fromRGB(55,60,70) or Color3.fromRGB(18,20,24); b.Text=(isSel(opt) and "v " or "  ")..opt; b.TextColor3=Color3.fromRGB(200,205,210); b.Font=Enum.Font.GothamBold; b.TextSize=10; b.ZIndex=2147483647
                Instance.new("UICorner",b).CornerRadius=UDim.new(0,6)
                b.MouseButton1Down:Connect(function() DM._optionDown=true end)
                b.MouseButton1Click:Connect(function()
                    local sel=Config.filterMutations; local found=false; for idx,v in pairs(sel) do if v==opt then table.remove(sel,idx); found=true; break end end; if not found then table.insert(sel,opt) end; Config.filterMutations=sel
                    b.BackgroundColor3=isSel(opt) and Color3.fromRGB(55,60,70) or Color3.fromRGB(18,20,24); b.Text=(isSel(opt) and "v " or "  ")..opt; dd.Text=getDisp(); saveConfig()
                end)
            end
        end
        fillMutOpts()
        dd.MouseButton1Down:Connect(function() DM._optionDown=true end)
        dd.MouseButton1Click:Connect(function()
            if DM.cur and DM.cur~=ocName then DM:close(false) end; if DM.cur==ocName then DM:close(false); return end
            fillMutOpts(); local bp2=dd.AbsolutePosition; local bs=dd.AbsoluteSize; local maxH=math.min(#MUTATION_LIST*26,200)
            oc.Position=UDim2.new(0,bp2.X,0,bp2.Y+bs.Y+2); oc.Size=UDim2.new(0,bs.X,0,maxH); oc.Visible=true; DM:open(ocName,oc,dd)
        end)
        task.spawn(function() while dd and dd.Parent do task.wait(1); dd.Text=getDisp() end end)
    end
    yo=yo+28
    mkSlider(coFr, "Interval", "collectInterval", 0, 1, yo, 0.05, function(v) return v==0 and "Interval: Instant" or "Interval: "..string.format("%g",v).."s" end); yo=yo+42
    mkBtn(coFr, "Collect Now", yo, function() task.spawn(autoCollect) end, GREEN)

    local dlBox = mkBox(fp, "Delete Plant", 0, 550, 495, 155, 10747362393)
    local dlSc = mkScroll(dlBox, 135); yo=0
    mkDD(dlSc, "Plant", function() return getPlantNames(false) end, "selectedDeletePlant", yo); yo=yo+28
    mkToggle(dlSc, "Auto Delete Plant", "autoDeletePlant", yo, function(e)
        if e then warnTPGarden(); startLoop("autoDelPlant", Config.deleteInterval, doAutoDeletePlant) else stopLoop("autoDelPlant") end
    end); yo=yo+30
    mkSlider(dlSc, "Interval", "deleteInterval", 1, 250, yo, 1, function(v) return "Delete Every: "..v.."s" end, function(v) 
        if Config.autoDeletePlant then startLoop("autoDelPlant", v, doAutoDeletePlant) end
    end); yo=yo+42
    mkBtn(dlSc, "Delete Now", yo, function() local p=Config.selectedDeletePlant; if p and p~="" then task.spawn(function() deletePlant(p) end) else showNotif("Delete","Select a plant first!",1.5) end end, GREEN)
    dlSc.CanvasSize=UDim2.new(0,0,0,yo+34)

    pages["Farm"] = fp; pageSizes["Farm"] = 730

    -- ==================== TAB 2: SHOP ====================
    local shp = Instance.new("Frame", cf); shp.Name = "Shop"; shp.Size = UDim2.new(1,0,0,600); shp.Position = UDim2.new(0,0,0,50); shp.BackgroundTransparency=1; shp.Visible=false
    local bsBox = mkBox(shp, "Buy Seed", 0, 0, 245, 290, 10734965572); local bsSc = mkScroll(bsBox, 265); yo=0
    mkToggle(bsSc, "Auto Buy Seed", "autoBuySeed", yo, function(e) if e then startLoop("buyseed", Config.buySeedInterval, function() if #Config.selectedBuySeeds>0 then doBuySeedBulk(Config.selectedBuySeeds, Config.buySeedAmount, true) end end) else stopLoop("buyseed") end end); yo=yo+30
    mkMDD(bsSc, "Seeds", SHOP_SEED_LIST, "selectedBuySeeds", yo); yo=yo+28
    mkSlider(bsSc, "Buy Every", "buySeedInterval", 1, 60, yo, 1, function(v) return "Buy Every: "..string.format("%g",v).."s" end); yo=yo+42
    mkSlider(bsSc, "Amount", "buySeedAmount", 1, 51, yo, 1, function(v) return v>=51 and "Amount: Max" or "Amount: x"..string.format("%g",v) end); yo=yo+42
    mkBtn(bsSc, "Buy Now", yo, function() task.spawn(function() if #Config.selectedBuySeeds==0 then showNotif("Buy","Select seeds first",1.5); return end; doBuySeedBulk(Config.selectedBuySeeds, Config.buySeedAmount, false) end) end, GREEN)
    local bgBox2 = mkBox(shp, "Buy Gear", 250, 0, 245, 290, 10747383065); local bgSc = mkScroll(bgBox2, 265); yo=0
    mkToggle(bgSc, "Auto Buy Gear", "autoBuyGear", yo, function(e) if e then startLoop("buygear", Config.buyGearInterval, function() if #Config.selectedGear>0 then doBuyGearBulk(Config.selectedGear, Config.buyGearAmount) end end) else stopLoop("buygear") end end); yo=yo+30
    mkMDD(bgSc, "Gear", GEAR_LIST, "selectedGear", yo); yo=yo+28
    mkSlider(bgSc, "Buy Every", "buyGearInterval", 1, 60, yo, 1, function(v) return "Buy Every: "..string.format("%g",v).."s" end); yo=yo+42
    mkSlider(bgSc, "Amount", "buyGearAmount", 1, 51, yo, 1, function(v) return v>=51 and "Amount: Max" or "Amount: x"..string.format("%g",v) end); yo=yo+42
    mkBtn(bgSc, "Buy Now", yo, function() task.spawn(function() if #Config.selectedGear>0 then doBuyGearBulk(Config.selectedGear, Config.buyGearAmount) end end) end, GREEN)
    pages["Shop"] = shp; pageSizes["Shop"] = 310

    -- ==================== TAB 3: QUEST ====================
    local qp = Instance.new("Frame", cf); qp.Name = "Quest"; qp.Size = UDim2.new(1,0,0,700); qp.Position = UDim2.new(0,0,0,50); qp.BackgroundTransparency=1; qp.Visible=false
    local qBox = mkBox(qp, "Auto Quest", 0, 0, 245, 155, 10709799288); local qSc = mkScroll(qBox, 135); yo=0
    mkToggle(qSc, "Auto Quest", "autoQuest", yo, function(e) if e then startLoop("questexec", 10, function() if Config.autoQuest then autoQuest() end end) else stopLoop("questexec") end end); yo=yo+30
    mkToggle(qSc, "Auto Claim Quest Reward", "autoClaimQuestReward", yo, function(e) if e then startLoop("questclaim", 60, function() if Config.autoClaimQuestReward then claimQuestRewards() end end) else stopLoop("questclaim") end end); yo=yo+30
    do
        local f=Instance.new("Frame",qSc); f.Size=UDim2.new(1,-16,0,26); f.Position=UDim2.new(0,8,0,yo); f.BackgroundTransparency=1; f.ZIndex=10000
        local l=Instance.new("TextLabel",f); l.Size=UDim2.new(0.42,0,1,0); l.BackgroundTransparency=1; l.Text="Type"; l.TextColor3=Color3.fromRGB(200,205,210); l.Font=Enum.Font.GothamBold; l.TextSize=11; l.TextXAlignment=Enum.TextXAlignment.Left
        local dd=createDDButton(f, 0, 22); dd.Size=UDim2.new(0.56,0,0,22); dd.Position=UDim2.new(0.43,0,0.5,-11); dd.Text="v Daily"
        local ocName="QTDD_"..tostring(tick()); local oc=Instance.new("ScrollingFrame"); oc.BackgroundColor3=Color3.fromRGB(18,20,24); oc.BorderSizePixel=0; oc.Visible=false; oc.ZIndex=2147483647; oc.ScrollBarThickness=4; oc.Parent=sg
        Instance.new("UICorner",oc).CornerRadius=UDim.new(0,8); oc.CanvasSize=UDim2.new(0,0,0,52)
        local b1=Instance.new("TextButton",oc); b1.Size=UDim2.new(1,0,0,26); b1.BackgroundColor3=Color3.fromRGB(55,60,70); b1.Text="v Daily"; b1.TextColor3=Color3.fromRGB(200,205,210); b1.Font=Enum.Font.GothamBold; b1.TextSize=10; b1.ZIndex=2147483647
        Instance.new("UICorner",b1).CornerRadius=UDim.new(0,6); b1.MouseButton1Down:Connect(function() DM._optionDown=true end); b1.MouseButton1Click:Connect(function() DM:close(false) end)
        local b2=Instance.new("TextButton",oc); b2.Size=UDim2.new(1,0,0,26); b2.Position=UDim2.new(0,0,0,26); b2.BackgroundColor3=Color3.fromRGB(18,20,24); b2.Text="  Weekly (WIP)"; b2.TextColor3=Color3.fromRGB(90,90,90); b2.Font=Enum.Font.GothamBold; b2.TextSize=10; b2.ZIndex=2147483647; b2.Active=false; b2.AutoButtonColor=false
        Instance.new("UICorner",b2).CornerRadius=UDim.new(0,6)
        dd.MouseButton1Down:Connect(function() DM._optionDown=true end)
        dd.MouseButton1Click:Connect(function()
            if DM.cur and DM.cur~=ocName then DM:close(false) end; if DM.cur==ocName then DM:close(false); return end
            local bp2=dd.AbsolutePosition; local bs=dd.AbsoluteSize; oc.Position=UDim2.new(0,bp2.X,0,bp2.Y+bs.Y+2); oc.Size=UDim2.new(0,bs.X,0,52); oc.Visible=true; DM:open(ocName,oc,dd)
        end)
    end
    yo=yo+28
    do
        local f=Instance.new("Frame",qSc); f.Size=UDim2.new(1,-16,0,26); f.Position=UDim2.new(0,8,0,yo); f.BackgroundTransparency=1; f.ZIndex=10000
        local l=Instance.new("TextLabel",f); l.Size=UDim2.new(0.42,0,1,0); l.BackgroundTransparency=1; l.Text="Select Quest"; l.TextColor3=Color3.fromRGB(200,205,210); l.Font=Enum.Font.GothamBold; l.TextSize=11; l.TextXAlignment=Enum.TextXAlignment.Left
        local dd=createDDButton(f, 0, 22); dd.Size=UDim2.new(0.56,0,0,22); dd.Position=UDim2.new(0.43,0,0.5,-11)
        local function getDisp() local s=Config.selectedQuests; if not s or #s==0 then return "v Select" elseif #s==1 then return "v "..s[1]:sub(1,18) else return "v "..#s.." quests" end end
        dd.Text=getDisp()
        local ocName="QDD_"..tostring(tick()); local oc=Instance.new("ScrollingFrame"); oc.BackgroundColor3=Color3.fromRGB(18,20,24); oc.BorderSizePixel=0; oc.Visible=false; oc.ZIndex=2147483647; oc.ScrollBarThickness=4; oc.Parent=sg
        Instance.new("UICorner",oc).CornerRadius=UDim.new(0,8)
        local function isSel(opt) for _,v in pairs(Config.selectedQuests) do if v==opt then return true end end; return false end
        local cOpts={}
        local function fillQ(opts)
            cOpts=opts; for _,c in pairs(oc:GetChildren()) do if c:IsA("TextButton") or c:IsA("TextLabel") then c:Destroy() end end
            if #opts==0 then oc.CanvasSize=UDim2.new(0,0,0,26); local nl=Instance.new("TextLabel",oc); nl.Size=UDim2.new(1,0,0,26); nl.BackgroundTransparency=1; nl.Text="Open Quests UI first"; nl.TextColor3=Color3.fromRGB(100,110,130); nl.Font=Enum.Font.Gotham; nl.TextSize=10; nl.ZIndex=2147483647; nl.TextXAlignment=Enum.TextXAlignment.Center; return end
            oc.CanvasSize=UDim2.new(0,0,0,#opts*26)
            for i,opt in ipairs(opts) do
                local b=Instance.new("TextButton",oc); b.Size=UDim2.new(1,0,0,26); b.Position=UDim2.new(0,0,0,(i-1)*26); b.BackgroundColor3=isSel(opt) and Color3.fromRGB(55,60,70) or Color3.fromRGB(18,20,24); b.Text=(isSel(opt) and "v " or "  ")..opt:sub(1,24); b.TextColor3=Color3.fromRGB(200,205,210); b.Font=Enum.Font.GothamBold; b.TextSize=10; b.ZIndex=2147483647
                Instance.new("UICorner",b).CornerRadius=UDim.new(0,6)
                b.MouseButton1Down:Connect(function() DM._optionDown=true end)
                b.MouseButton1Click:Connect(function()
                    local sel=Config.selectedQuests; local found=false; for idx,v in pairs(sel) do if v==opt then table.remove(sel,idx); found=true; break end end; if not found then table.insert(sel,opt) end; Config.selectedQuests=sel
                    b.BackgroundColor3=isSel(opt) and Color3.fromRGB(55,60,70) or Color3.fromRGB(18,20,24); b.Text=(isSel(opt) and "v " or "  ")..opt:sub(1,24); dd.Text=getDisp(); saveConfig()
                end)
            end
        end
        fillQ(_questRawCache or {}); hookUpdateQuests()
        dd.MouseButton1Down:Connect(function() DM._optionDown=true end)
        dd.MouseButton1Click:Connect(function()
            if DM.cur and DM.cur~=ocName then DM:close(false) end; if DM.cur==ocName then DM:close(false); return end
            local opts=fastScanQuests(); fillQ(opts); local bp2=dd.AbsolutePosition; local bs=dd.AbsoluteSize; local maxH=math.min(math.max(#cOpts,1)*26,200)
            oc.Position=UDim2.new(0,bp2.X,0,bp2.Y+bs.Y+2); oc.Size=UDim2.new(0,bs.X+50,0,maxH); oc.Visible=true; DM:open(ocName,oc,dd)
        end)
        task.spawn(function() while dd and dd.Parent do task.wait(1); dd.Text=getDisp() end end)
    end
    yo=yo+28; qSc.CanvasSize=UDim2.new(0,0,0,yo+10)

    local packBox = mkBox(qp, "Auto Open Seedpack", 250, 0, 245, 155, 10734965572)
    local packSc = mkScroll(packBox, 135); yo=0
    mkToggle(packSc, "Auto Open Pack", "autoOpenPack", yo, function(e)
        if e then startLoop("autoPack", Config.packOpenInterval + 0.5, doAutoOpenPack) else stopLoop("autoPack") end
    end); yo=yo+30
    mkDD(packSc, "Select Pack", SEED_PACK_LIST, "selectedPack", yo); yo=yo+28
    mkSlider(packSc, "Interval", "packOpenInterval", 0.5, 10, yo, 0.5, function(v) return "Interval: "..string.format("%g",v).."s" end); yo=yo+42
    packSc.CanvasSize=UDim2.new(0,0,0,yo+10)

    local appBox = mkBox(qp, "Auto Appraiser", 250, 161, 245, 155, 10709790537)
    local appSc = mkScroll(appBox, 135); yo=0
    mkToggle(appSc, "Auto Appraise", "autoAppraise", yo, function(e)
        if e then startLoop("autoAppraise", Config.appraiseInterval, doAutoAppraise) else stopLoop("autoAppraise") end
    end); yo=yo+30
    mkSlider(appSc, "Interval", "appraiseInterval", 0.1, 10, yo, 0.1, function(v) return "Appraise Ev.: "..string.format("%g",v).."s" end); yo=yo+42
    mkMDD(appSc, "Target Mutations", MUTATION_LIST, "appraiseMutations", yo); yo=yo+30
    appSc.CanvasSize=UDim2.new(0,0,0,yo+10)

    local maraBox = mkBox(qp, "Auto Mara Quest", 0, 161, 245, 155, 10709805096)
    local maraSc = mkScroll(maraBox, 135); yo=0
    mkToggle(maraSc, "Auto refresh Mara quest", "autoRefreshMara", yo, function(e)
        if e or Config.autoCompleteMara then startLoop("autoMara", Config.maraQuestInterval, doAutoMaraQuest) else stopLoop("autoMara") end
    end); yo=yo+30
    mkToggle(maraSc, "Auto Complete Mara Quest", "autoCompleteMara", yo, function(e)
        if e or Config.autoRefreshMara then startLoop("autoMara", Config.maraQuestInterval, doAutoMaraQuest) else stopLoop("autoMara") end
    end); yo=yo+30
    mkSlider(maraSc, "Refresh Interval", "maraQuestInterval", 1, 30, yo, 1, function(v) return "Refresh Int.: "..string.format("%g",v).."s" end); yo=yo+42
    maraSc.CanvasSize=UDim2.new(0,0,0,yo+10)

    pages["Quest"] = qp; pageSizes["Quest"] = 340

    -- ==================== TAB 4: PLAYER ====================
    local plrp = Instance.new("Frame", cf); plrp.Name = "Player"; plrp.Size = UDim2.new(1,0,0,700); plrp.Position = UDim2.new(0,0,0,50); plrp.BackgroundTransparency=1; plrp.Visible=false

    local pcBox = mkBox(plrp, "Player", 0, 0, 245, 235, 10747366606); local pcSc = mkScroll(pcBox, 215); yo=0
    mkSlider(pcSc, "WalkSpeed", "walkSpeed", 16, 150, yo, 1, function(v) return "WalkSpeed: "..string.format("%g",v) end, applyWS); yo=yo+42
    mkSlider(pcSc, "JumpPower", "jumpPower", 7.2, 200, yo, 0.1, function(v) return "JumpPower: "..string.format("%g",v) end, applyJP); yo=yo+42
    mkSlider(pcSc, "Fly Speed", "flySpeed", 10, 200, yo, 5, function(v) return "Fly Speed: "..string.format("%g",v) end); yo=yo+42
    mkToggle(pcSc, "Fly", "fly", yo, function(e) if e then startFly() else stopFly() end end); yo=yo+30
    mkBtn(pcSc, "Reset Speed", yo, function() Config.walkSpeed=16; Config.jumpPower=7.2; saveConfig(); applyWS(16); applyJP(7.2) end, GRY)

    local espBox = mkBox(plrp, "ESP", 250, 0, 245, 228, 10709790537)
    local espSc = mkScroll(espBox, 210); yo=0
    mkDD(espSc, "ESP Mode", {"Fruit ESP","Mutations ESP","Player ESP","NPC ESP"}, "espMode", yo, function(m)
        if m == "Fruit ESP" or m == "Mutations ESP" then warnTPGarden() end
        if Config.espEnabled then task.spawn(runESP) end
    end); yo=yo+28
    do
        local f=Instance.new("Frame",espSc); f.Size=UDim2.new(1,-16,0,26); f.Position=UDim2.new(0,8,0,yo); f.BackgroundTransparency=1; f.ZIndex=10000
        local l=Instance.new("TextLabel",f); l.Size=UDim2.new(0.42,0,1,0); l.BackgroundTransparency=1; l.Text="Mutation Filter"; l.TextColor3=Color3.fromRGB(200,205,210); l.Font=Enum.Font.GothamBold; l.TextSize=10; l.TextXAlignment=Enum.TextXAlignment.Left
        local dd=createDDButton(f, 0, 22); dd.Size=UDim2.new(0.56,0,0,22); dd.Position=UDim2.new(0.43,0,0.5,-11)
        dd.Text = Config.espSelectedMutation ~="" and "v "..Config.espSelectedMutation or "v All"
        local ocName="ESP_MUT_DD_"..tostring(tick()); local oc=Instance.new("ScrollingFrame"); oc.BackgroundColor3=Color3.fromRGB(18,20,24); oc.BorderSizePixel=0; oc.Visible=false; oc.ZIndex=2147483647; oc.ScrollBarThickness=4; oc.Parent=sg
        Instance.new("UICorner",oc).CornerRadius=UDim.new(0,8)
        local mutOpts = table.clone(MUTATION_LIST); table.insert(mutOpts, 1, "All")
        oc.CanvasSize=UDim2.new(0,0,0,#mutOpts*26)
        for i,opt in ipairs(mutOpts) do
            local b=Instance.new("TextButton",oc); b.Size=UDim2.new(1,0,0,26); b.Position=UDim2.new(0,0,0,(i-1)*26); b.BackgroundColor3=Color3.fromRGB(18,20,24); b.Text=opt; b.TextColor3=Color3.fromRGB(200,205,210); b.Font=Enum.Font.GothamBold; b.TextSize=10; b.ZIndex=2147483647
            Instance.new("UICorner",b).CornerRadius=UDim.new(0,6)
            b.MouseButton1Down:Connect(function() DM._optionDown=true end)
            b.MouseButton1Click:Connect(function()
                Config.espSelectedMutation = opt=="All" and "" or opt
                dd.Text = opt=="All" and "v All" or "v "..opt
                DM:close(false); saveConfig()
                if Config.espEnabled then task.spawn(runESP) end
            end)
        end
        dd.MouseButton1Down:Connect(function() DM._optionDown=true end)
        dd.MouseButton1Click:Connect(function()
            if DM.cur and DM.cur~=ocName then DM:close(false) end; if DM.cur==ocName then DM:close(false); return end
            local bp2=dd.AbsolutePosition; local bs=dd.AbsoluteSize; local maxH=math.min(#mutOpts*26,200)
            oc.Position=UDim2.new(0,bp2.X,0,bp2.Y+bs.Y+2); oc.Size=UDim2.new(0,bs.X,0,maxH); oc.Visible=true; DM:open(ocName,oc,dd)
        end)
    end
    yo=yo+28
    mkToggle(espSc, "Enable ESP", "espEnabled", yo, function(e)
        if e then task.spawn(runESP) else clearESP() end
    end); yo=yo+30
    mkToggle(espSc, "ESP All Plants In Inventory", "espAllInventory", yo, function(e)
        if e then updateInvESP() else clearInvESP() end
    end); yo=yo+30
    mkBtn(espSc, "Refresh ESP", yo, function() if Config.espEnabled then task.spawn(runESP) end; if Config.espAllInventory then updateInvESP() end end, GRY)
    espSc.CanvasSize=UDim2.new(0,0,0,yo+34)

    local visBox = mkBox(plrp, "Visual / Give", 0, 241, 495, 170, "ðŸ‘")
    local visSc = mkScroll(visBox, 155); yo=0
    mkToggle(visSc, "INF Shillings (Visual)", "infMoney", yo, function(e) if e then enableInfMoney() else disableInfMoney() end end); yo=yo+30
    do
        local fl=Instance.new("Frame",visSc); fl.Size=UDim2.new(1,-16,0,26); fl.Position=UDim2.new(0,8,0,yo); fl.BackgroundTransparency=1; fl.ZIndex=10000
        local l=Instance.new("TextLabel",fl); l.Size=UDim2.new(0.42,0,1,0); l.BackgroundTransparency=1; l.Text="Seed"; l.TextColor3=Color3.fromRGB(200,205,210); l.Font=Enum.Font.GothamBold; l.TextSize=11; l.TextXAlignment=Enum.TextXAlignment.Left
        local dd=createDDButton(fl, 0, 22); dd.Size=UDim2.new(0.56,0,0,22); dd.Position=UDim2.new(0.43,0,0.5,-11)
        if not Config.giveSeedName then Config.giveSeedName=SHOP_SEED_LIST[1] end
        dd.Text="v "..Config.giveSeedName
        local ocNameSd="GSEED_DD_"..tostring(tick()); local ocSd=Instance.new("ScrollingFrame"); ocSd.BackgroundColor3=Color3.fromRGB(18,20,24); ocSd.BorderSizePixel=0; ocSd.Visible=false; ocSd.ZIndex=2147483647; ocSd.ScrollBarThickness=4; ocSd.Parent=sg
        Instance.new("UICorner",ocSd).CornerRadius=UDim.new(0,8)
        local allSeedOpts = {}
        do
            local raw = getAllSeedNamesCached and getAllSeedNamesCached() or SHOP_SEED_LIST
            local nonSeedPatterns = {"controller","cutscene","rainlb","shopdata","shopcontroller","seedbegin","seedbox","seedtype","^seeds$"}
            for _, n in ipairs(raw) do
                local lc = n:lower(); local skip = false
                for _, pat in ipairs(nonSeedPatterns) do if lc:find(pat) then skip=true; break end end
                if not skip then table.insert(allSeedOpts, n) end
            end
            if #allSeedOpts == 0 then allSeedOpts = SHOP_SEED_LIST end
        end
        ocSd.CanvasSize=UDim2.new(0,0,0,#allSeedOpts*26)
        for i,opt in ipairs(allSeedOpts) do
            local b=Instance.new("TextButton",ocSd); b.Size=UDim2.new(1,0,0,26); b.Position=UDim2.new(0,0,0,(i-1)*26); b.BackgroundColor3=Color3.fromRGB(18,20,24); b.Text=opt; b.TextColor3=Color3.fromRGB(200,205,210); b.Font=Enum.Font.GothamBold; b.TextSize=10; b.ZIndex=2147483647
            Instance.new("UICorner",b).CornerRadius=UDim.new(0,6)
            b.MouseButton1Down:Connect(function() DM._optionDown=true end)
            b.MouseButton1Click:Connect(function() Config.giveSeedName=opt; dd.Text="v "..opt; DM:close(false); saveConfig() end)
        end
        dd.MouseButton1Down:Connect(function() DM._optionDown=true end)
        dd.MouseButton1Click:Connect(function()
            if DM.cur and DM.cur~=ocNameSd then DM:close(false) end; if DM.cur==ocNameSd then DM:close(false); return end
            local bp2=dd.AbsolutePosition; local bs=dd.AbsoluteSize; local maxH=math.min(#allSeedOpts*26,200)
            ocSd.Position=UDim2.new(0,bp2.X,0,bp2.Y+bs.Y+2); ocSd.Size=UDim2.new(0,bs.X,0,maxH); ocSd.Visible=true; DM:open(ocNameSd,ocSd,dd)
        end)
        yo=yo+28
    end
    if not Config.giveSeedAmount then Config.giveSeedAmount=1 end
    mkSlider(visSc, "Give Amount", "giveSeedAmount", 1, 99, yo, 1, function(v) return "Give Amount: "..string.format("%g",v) end); yo=yo+42
    mkBtn(visSc, "Give Selected Seed", yo, function()
        local seedName=Config.giveSeedName or SHOP_SEED_LIST[1]; local amount=Config.giveSeedAmount or 1
        local tool=Instance.new("Tool"); tool.Name=seedName.." x"..amount; tool.RequiresHandle=false; tool.CanBeDropped=false
        tool:SetAttribute("BaseName",seedName); tool:SetAttribute("Type","Seeds"); tool:SetAttribute("Amount",amount); tool:SetAttribute("ItemCount",amount)
        local h=Instance.new("Part",tool); h.Name="Handle"; h.Size=Vector3.new(1,1,1); h.Transparency=1; h.CanCollide=false
        tool.Parent=plr.Backpack; showNotif("Visual","Spawned "..seedName.." x"..amount,1.5)
    end, GRY)
    visSc.CanvasSize=UDim2.new(0,0,0,yo+34)

    pages["Player"] = plrp; pageSizes["Player"] = 440

    -- ==================== TAB 5: MISC ====================
    local misc = Instance.new("Frame", cf); misc.Name = "Misc"; misc.Size = UDim2.new(1,0,0,700); misc.Position = UDim2.new(0,0,0,50); misc.BackgroundTransparency=1; misc.Visible=false

    local cpBox = mkBox(misc, "Plot & Garden TP", 0, 0, 245, 210, 10723407335); local yo2=28
    local sepClaim=Instance.new("TextLabel",cpBox); sepClaim.Size=UDim2.new(1,-16,0,14); sepClaim.Position=UDim2.new(0,8,0,yo2); sepClaim.BackgroundTransparency=1; sepClaim.Text="--- Claim Plot ---"; sepClaim.TextColor3=Color3.fromRGB(140,148,160); sepClaim.Font=Enum.Font.GothamBold; sepClaim.TextSize=9; sepClaim.TextXAlignment=Enum.TextXAlignment.Center; yo2=yo2+16
    do
        local f=Instance.new("Frame",cpBox); f.Size=UDim2.new(1,-16,0,28); f.Position=UDim2.new(0,8,0,yo2); f.BackgroundTransparency=1; f.ZIndex=10000
        local l=Instance.new("TextLabel",f); l.Size=UDim2.new(0.65,0,1,0); l.BackgroundTransparency=1; l.Text="Auto Claim"; l.TextColor3=Color3.fromRGB(200,205,210); l.Font=Enum.Font.GothamBold; l.TextSize=11; l.TextXAlignment=Enum.TextXAlignment.Left
        local track=Instance.new("TextButton",f); track.Size=UDim2.new(0,46,0,22); track.Position=UDim2.new(1,-46,0.5,-11)
        track.BackgroundColor3=Config.autoClaimPlot and GREEN or GRY; track.Text=""; track.AutoButtonColor=false; track.ZIndex=10001
        Instance.new("UICorner",track).CornerRadius=UDim.new(0.5,0)
        local knob=Instance.new("Frame",track); knob.Name="Knob"; knob.Size=UDim2.new(0,16,0,16); knob.Position=Config.autoClaimPlot and UDim2.new(1,-19,0.5,-8) or UDim2.new(0,3,0.5,-8); knob.BackgroundColor3=Color3.fromRGB(255,255,255); knob.BorderSizePixel=0; knob.ZIndex=10002
        Instance.new("UICorner",knob).CornerRadius=UDim.new(0.5,0)
        _toggleRefs["autoClaimPlot"]=track
        track.MouseButton1Click:Connect(function()
            Config.autoClaimPlot=not Config.autoClaimPlot; local on=Config.autoClaimPlot
            TweenService:Create(track,TweenInfo.new(0.2,Enum.EasingStyle.Quad),{BackgroundColor3=on and GREEN or GRY}):Play()
            TweenService:Create(knob,TweenInfo.new(0.2,Enum.EasingStyle.Quad),{Position=on and UDim2.new(1,-19,0.5,-8) or UDim2.new(0,3,0.5,-8)}):Play()
            saveConfig(); notifyTog("Auto Claim",on); if on then runAutoClaim() end
        end)
    end
    yo2=yo2+30
    do
        local b=Instance.new("TextButton",cpBox); b.Size=UDim2.new(1,-16,0,26); b.Position=UDim2.new(0,8,0,yo2); b.BackgroundColor3=GREEN; b.Text="Claim Now"; b.TextColor3=Color3.new(1,1,1); b.Font=Enum.Font.GothamBold; b.TextSize=10; b.ZIndex=10000
        Instance.new("UICorner",b).CornerRadius=UDim.new(0,6); b.MouseButton1Click:Connect(function() task.spawn(doClaimViaUI) end)
    end
    yo2=yo2+34
    local div2=Instance.new("Frame",cpBox); div2.Size=UDim2.new(1,-16,0,1); div2.Position=UDim2.new(0,8,0,yo2); div2.BackgroundColor3=Color3.fromRGB(40,42,48); div2.BorderSizePixel=0; yo2=yo2+8
    local tpSepL=Instance.new("TextLabel",cpBox); tpSepL.Size=UDim2.new(1,-16,0,14); tpSepL.Position=UDim2.new(0,8,0,yo2); tpSepL.BackgroundTransparency=1; tpSepL.Text="--- Auto TP to Garden ---"; tpSepL.TextColor3=Color3.fromRGB(140,148,160); tpSepL.Font=Enum.Font.GothamBold; tpSepL.TextSize=9; tpSepL.TextXAlignment=Enum.TextXAlignment.Center; yo2=yo2+16
    local everyLbl=Instance.new("TextLabel",cpBox); everyLbl.Size=UDim2.new(1,-16,0,16); everyLbl.Position=UDim2.new(0,8,0,yo2); everyLbl.BackgroundTransparency=1; everyLbl.Text="Every: "..Config.tpGardenInterval.."s"; everyLbl.TextColor3=Color3.fromRGB(200,205,210); everyLbl.Font=Enum.Font.GothamBold; everyLbl.TextSize=10; everyLbl.TextXAlignment=Enum.TextXAlignment.Left; yo2=yo2+18
    do
        local sliderF=Instance.new("Frame",cpBox); sliderF.Size=UDim2.new(1,-16,0,10); sliderF.Position=UDim2.new(0,8,0,yo2); sliderF.BackgroundTransparency=1; sliderF.ZIndex=10000
        local bg2=Instance.new("Frame",sliderF); bg2.Size=UDim2.new(1,0,0,6); bg2.BackgroundColor3=Color3.fromRGB(28,30,35); bg2.BorderSizePixel=0; bg2.ZIndex=10000; Instance.new("UICorner",bg2).CornerRadius=UDim.new(0,3)
        local fi2=Instance.new("Frame",bg2); local mn2,mx2,step2=60,900,30; fi2.Size=UDim2.new((Config.tpGardenInterval-mn2)/(mx2-mn2),0,1,0); fi2.BackgroundColor3=BP; fi2.BorderSizePixel=0; fi2.ZIndex=10000; Instance.new("UICorner",fi2).CornerRadius=UDim.new(0,3)
        local dr2=false
        bg2.InputBegan:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then dr2=true end end)
        bg2.InputEnded:Connect(function(i) if i.UserInputType==Enum.UserInputType.MouseButton1 then dr2=false end end)
        UIS.InputChanged:Connect(function(i)
            if dr2 and i.UserInputType==Enum.UserInputType.MouseMovement then
                local p=math.clamp((i.Position.X-bg2.AbsolutePosition.X)/bg2.AbsoluteSize.X,0,1)
                local v=math.clamp(math.floor((mn2+(p*(mx2-mn2)))/step2+0.5)*step2,mn2,mx2)
                Config.tpGardenInterval=v; fi2.Size=UDim2.new((v-mn2)/(mx2-mn2),0,1,0); everyLbl.Text="Every: "..v.."s"; saveConfig()
            end
        end)
        yo2=yo2+14
    end
    do
        local f=Instance.new("Frame",cpBox); f.Size=UDim2.new(1,-16,0,28); f.Position=UDim2.new(0,8,0,yo2); f.BackgroundTransparency=1; f.ZIndex=10000
        local l=Instance.new("TextLabel",f); l.Size=UDim2.new(0.65,0,1,0); l.BackgroundTransparency=1; l.Text="Auto TP Garden"; l.TextColor3=Color3.fromRGB(200,205,210); l.Font=Enum.Font.GothamBold; l.TextSize=11; l.TextXAlignment=Enum.TextXAlignment.Left
        local track=Instance.new("TextButton",f); track.Size=UDim2.new(0,46,0,22); track.Position=UDim2.new(1,-46,0.5,-11)
        track.BackgroundColor3=Config.autoTPGarden and GREEN or GRY; track.Text=""; track.AutoButtonColor=false; track.ZIndex=10001
        Instance.new("UICorner",track).CornerRadius=UDim.new(0.5,0)
        local knob=Instance.new("Frame",track); knob.Name="Knob"; knob.Size=UDim2.new(0,16,0,16); knob.Position=Config.autoTPGarden and UDim2.new(1,-19,0.5,-8) or UDim2.new(0,3,0.5,-8); knob.BackgroundColor3=Color3.fromRGB(255,255,255); knob.BorderSizePixel=0; knob.ZIndex=10002
        Instance.new("UICorner",knob).CornerRadius=UDim.new(0.5,0)
        _toggleRefs["autoTPGarden"]=track
        track.MouseButton1Click:Connect(function()
            Config.autoTPGarden=not Config.autoTPGarden; local on=Config.autoTPGarden
            TweenService:Create(track,TweenInfo.new(0.2,Enum.EasingStyle.Quad),{BackgroundColor3=on and GREEN or GRY}):Play()
            TweenService:Create(knob,TweenInfo.new(0.2,Enum.EasingStyle.Quad),{Position=on and UDim2.new(1,-19,0.5,-8) or UDim2.new(0,3,0.5,-8)}):Play()
            saveConfig(); notifyTog("Auto TP Garden",on)
            if on then startLoop("tpgarden",Config.tpGardenInterval,function() if not Config.autoTPGarden then return end; doTPGarden() end) else stopLoop("tpgarden") end
        end)
    end

    local fpsBox=mkBox(misc,"FPS Boost",250,0,245,70,10747363205); mkDD(fpsBox,"Level",{"Off","Small","High"},"fpsBoostLevel",28,function(l) applyFPS(l) end)
    local rjBox=mkBox(misc,"Auto Rejoin",250,78,245,62,10734933056)
    mkToggle(rjBox,"Auto Rejoin","autoRejoin",28,function(e) if e then game:GetService("NetworkClient").ChildRemoved:Connect(function() if Config.autoRejoin then task.wait(2); pcall(function() TeleportService:Teleport(game.PlaceId,plr) end) end end) end end)
    local codeBox=mkBox(misc,"Codes",0,218,245,62,10723396402); mkBtn(codeBox,"Redeem All Codes",28,redeemCodes,GREEN)

    local cfgBoxH=240; local cfgBox=mkBox(misc,"Config",250,148,245,cfgBoxH,10734950309); local cfgSc=mkScroll(cfgBox,cfgBoxH-32); local cyo=0
    mkToggle(cfgSc,"Auto Save Config","autoSaveConfig",cyo,function(e) if e then saveConfigForce() else showNotif("Config","Auto Save OFF",1) end end); cyo=cyo+30
    local cfgDiv=Instance.new("Frame",cfgSc); cfgDiv.Size=UDim2.new(1,-16,0,1); cfgDiv.Position=UDim2.new(0,8,0,cyo); cfgDiv.BackgroundColor3=Color3.fromRGB(40,42,48); cfgDiv.BorderSizePixel=0; cyo=cyo+8
    local cfgNameLbl=Instance.new("TextLabel",cfgSc); cfgNameLbl.Size=UDim2.new(1,-16,0,14); cfgNameLbl.Position=UDim2.new(0,8,0,cyo); cfgNameLbl.BackgroundTransparency=1; cfgNameLbl.Text="Config Name:"; cfgNameLbl.TextColor3=Color3.fromRGB(180,200,230); cfgNameLbl.Font=Enum.Font.GothamBold; cfgNameLbl.TextSize=10; cfgNameLbl.TextXAlignment=Enum.TextXAlignment.Left; cyo=cyo+16
    local cfgNameBox=Instance.new("TextBox",cfgSc); cfgNameBox.Size=UDim2.new(1,-16,0,24); cfgNameBox.Position=UDim2.new(0,8,0,cyo); cfgNameBox.BackgroundColor3=Color3.fromRGB(18,23,35); cfgNameBox.BorderSizePixel=0; cfgNameBox.Text=""; cfgNameBox.PlaceholderText="Enter name..."; cfgNameBox.TextColor3=Color3.fromRGB(240,240,240); cfgNameBox.PlaceholderColor3=Color3.fromRGB(110,120,140); cfgNameBox.Font=Enum.Font.Gotham; cfgNameBox.TextSize=10; cfgNameBox.ZIndex=10000; cfgNameBox.ClearTextOnFocus=false
    Instance.new("UICorner",cfgNameBox).CornerRadius=UDim.new(0,6)
    cfgNameBox:GetPropertyChangedSignal("Text"):Connect(function() _configNameInput=cfgNameBox.Text end); cyo=cyo+30
    mkBtn(cfgSc,"Create Config",cyo,function() createNamedConfig(_configNameInput) end,GREEN); cyo=cyo+32
    mkDD(cfgSc,"Config List",function() local names=getSavedConfigNames(); if #names==0 then return {"None"} end; return names end,"selectedConfigName",cyo,function(sel) if sel=="None" then Config.selectedConfigName="" end end); cyo=cyo+28
    mkBtn(cfgSc,"Load Config",cyo,function() local name=Config.selectedConfigName; if name=="" or name=="None" then showNotif("Config","Select a config first!",2); return end; loadNamedConfig(name) end,BP); cyo=cyo+32
    local delBtn=Instance.new("TextButton",cfgSc); delBtn.Size=UDim2.new(1,-16,0,26); delBtn.Position=UDim2.new(0,8,0,cyo); delBtn.BackgroundColor3=RED; delBtn.Text="Delete Selected Config"; delBtn.TextColor3=Color3.new(1,1,1); delBtn.Font=Enum.Font.GothamBold; delBtn.TextSize=10; delBtn.ZIndex=10000
    Instance.new("UICorner",delBtn).CornerRadius=UDim.new(0,6)
    delBtn.MouseButton1Click:Connect(function() local name=Config.selectedConfigName; if name=="" or name=="None" then showNotif("Config","Select a config first!",2); return end; deleteNamedConfig(name) end)
    cyo=cyo+32; cfgSc.CanvasSize=UDim2.new(0,0,0,cyo+10)
    pages["Misc"] = misc; pageSizes["Misc"] = 400

    -- ==================== TAB NAV ====================
    local function setHL(name)
        for _,b in pairs(sidebar:GetChildren()) do
            if b:IsA("TextButton") then
                b.BackgroundColor3=Color3.fromRGB(16,17,20)
                local ico=b:FindFirstChild("TabIcon"); if ico then ico.ImageColor3=Color3.fromRGB(100,105,115) end
            end
        end
        local b=sidebar:FindFirstChild(name.."Btn"); if b then
            b.BackgroundColor3=BDK
            local ico=b:FindFirstChild("TabIcon"); if ico then ico.ImageColor3=Color3.fromRGB(255,255,255) end
        end
    end
    local function switchPage(name)
        DM:close(false); for n,p in pairs(pages) do p.Visible=(n==name) end
        ms.CanvasSize=UDim2.new(0,0,0,(pageSizes[name] or 400)+60); ms.CanvasPosition=Vector2.new(0,0); setHL(name)
    end
    mkTab(sidebar,10734965572,"Farm",1,function() switchPage("Farm") end)
    mkTab(sidebar,10734952273,"Shop",2,function() switchPage("Shop") end)
    mkTab(sidebar,10709798792,"Quest",3,function() switchPage("Quest") end)
    mkTab(sidebar,10747371901,"Player",4,function() switchPage("Player") end)
    mkTab(sidebar,10734950309,"Misc",5,function() switchPage("Misc") end)
    switchPage("Farm")
end

-- ============ MINI UI ============
local function buildMini()
    if MiniUI then MiniUI:Destroy() end
    MiniUI = Instance.new("ScreenGui"); MiniUI.Name = "CloudyzHubMini"; MiniUI.ResetOnSpawn = false; MiniUI.IgnoreGuiInset = true; MiniUI.Enabled = false; MiniUI.Parent = CoreGui
    local mf = Instance.new("Frame", MiniUI); mf.Size = UDim2.new(0, 50, 0, 50); mf.Position = UDim2.new(0, 15, 0.5, -25); mf.BackgroundColor3 = Color3.fromRGB(16, 17, 20); mf.BorderSizePixel = 0
    Instance.new("UICorner", mf).CornerRadius = UDim.new(0, 12)
    local mfStr = Instance.new("UIStroke", mf); mfStr.Color = BP; mfStr.Thickness = 1.5
    local mc = Instance.new("TextButton", mf); mc.Size = UDim2.new(1, 0, 1, 0); mc.BackgroundTransparency = 1; mc.Text = ""
    local mcTxt = Instance.new("TextLabel", mf); mcTxt.Size = UDim2.new(1, 0, 1, 0); mcTxt.BackgroundTransparency = 1; mcTxt.Text = utf8.char(0x2601); mcTxt.TextColor3 = Color3.fromRGB(180, 210, 255); mcTxt.Font = Enum.Font.GothamBold; mcTxt.TextSize = 26; mcTxt.ZIndex = 2
    mc.MouseButton1Click:Connect(function()
        if MainUI then MainUI.Enabled = true; local bg2 = MainUI:FindFirstChild("BG"); if bg2 then bg2.Size = UDim2.new(0, 0, 0, 0); TweenService:Create(bg2, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), { Size = UDim2.new(0, 575, 0, 380) }):Play() end end
        MiniUI.Enabled = false
    end)
    local d2, ds2, sp2 = false, nil, nil
    mf.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
            d2 = true; ds2 = i.Position; sp2 = mf.Position; i.Changed:Connect(function() if i.UserInputState == Enum.UserInputState.End then d2 = false end end)
        end
    end)
    UIS.InputChanged:Connect(function(i)
        if d2 and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
            local d = i.Position - ds2; mf.Position = UDim2.new(sp2.X.Scale, sp2.X.Offset + d.X, sp2.Y.Scale, sp2.Y.Offset + d.Y)
        end
    end)
end

-- ============ STATUS LOOP ============
local lastStatusUpdate = 0
task.spawn(function()
    while task.wait(0.5) do
        if StatusLabel and StatusLabel.Parent then
            if tick() - lastStatusUpdate >= 1 then
                lastStatusUpdate = tick()
                local plot = getPlot(); local seeds = getSeedNames()
                local clientPlants = Workspace:FindFirstChild("ClientPlants")
                local plantCount = clientPlants and #clientPlants:GetChildren() or #getPlants()
                local active = {}
                if Config.fly then table.insert(active, "Fly") end
                if Config.autoPlant then table.insert(active, "Plant") end
                if Config.autoCollect then
                    local mutStr = #Config.filterMutations > 0 and "[" .. #Config.filterMutations .. "mut]" or ""
                    table.insert(active, "Collect" .. mutStr)
                end
                if Config.autoSell then table.insert(active, "Sell") end
                if Config.autoWater then table.insert(active, "Water") end
                if Config.autoSprinkler then table.insert(active, "Sprinkler") end
                if Config.autoTPGarden then table.insert(active, "TPGarden") end
                if Config.autoFavorite then table.insert(active, "Fav") end
                if Config.autoOpenPack then table.insert(active, "Pack") end
                if Config.espEnabled then table.insert(active, "ESP") end
                if _toolMutex then table.insert(active, "[BUSY]") end
                local invC = getInvCount(); local st = #active > 0 and table.concat(active, " | ") or "Idle"
                StatusLabel.Text = string.format("Plot: %s | Seeds: %d | Plants: %d | Inv: %d | %s",
                    plot and plot.Name or "None", #seeds, plantCount, invC, st)
            end
        end
    end
end)

-- ============ RIGHTSHIFT TOGGLE ============
UIS.InputBegan:Connect(function(input, gp)
    if not gp and input.KeyCode == Enum.KeyCode.RightShift then
        if MainUI then
            if MainUI.Enabled then
                MainUI.Enabled = false; if MiniUI then MiniUI.Enabled = true end
            else
                MainUI.Enabled = true; if MiniUI then MiniUI.Enabled = false end
                local bg2 = MainUI:FindFirstChild("BG"); if bg2 then
                    bg2.Size = UDim2.new(0, 0, 0, 0)
                    TweenService:Create(bg2, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), { Size = UDim2.new(0, 575, 0, 380) }):Play()
                end
            end
        end
    end
end)

-- ============ INIT ============
buildUI(); buildMini()
task.spawn(function()
    task.wait(1)
    applyWS(Config.walkSpeed); applyJP(Config.jumpPower)
    if Config.fly then startFly() end
    if Config.infMoney then enableInfMoney() end
    if Config.autoPlant then startLoop("plant", Config.plantInterval + 0.5, autoPlant) end
    if Config.autoCollect then startLoop("collect", 2, autoCollect) end
    if Config.autoSell then startLoop("sell", Config.sellInterval, doSell) end
    if Config.autoWater then startLoop("water", Config.waterInterval, autoWater) end
    if Config.autoSprinkler then startLoop("sprinkler", Config.sprinklerInterval, autoPlaceSprinkler) end
    if Config.autoTPGarden then startLoop("tpgarden", Config.tpGardenInterval, doTPGarden) end
    if Config.autoBuySeed then startLoop("buyseed", Config.buySeedInterval, function() if #Config.selectedBuySeeds > 0 then doBuySeedBulk(Config.selectedBuySeeds, Config.buySeedAmount, true) end end) end
    if Config.autoBuyGear then startLoop("buygear", Config.buyGearInterval, function() if #Config.selectedGear > 0 then doBuyGearBulk(Config.selectedGear, Config.buyGearAmount) end end) end
    if Config.autoQuest then startLoop("questexec", 10, function() if Config.autoQuest then autoQuest() end end) end
    if Config.autoClaimQuestReward then startLoop("questclaim", 60, function() if Config.autoClaimQuestReward then claimQuestRewards() end end) end
    if Config.autoFavorite then startLoop("autoFav", 3, doAutoFavorite) end
    if Config.autoOpenPack then startLoop("autoPack", Config.packOpenInterval + 0.5, doAutoOpenPack) end
    if Config.autoDeletePlant then startLoop("autoDelPlant", Config.deleteInterval, doAutoDeletePlant) end
    if Config.espEnabled then task.spawn(runESP) end
    if Config.espAllInventory then updateInvESP() end
end)

task.spawn(function()
    task.wait(5)
    if Config.autoClaimPlot and not hasPlot() then runAutoClaim() end
end)

showNotif("Cloudyz Hub v1.0", "Loaded! RightShift to toggle", 3)
